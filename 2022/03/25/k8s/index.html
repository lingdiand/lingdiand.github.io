

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  
  <title>k8s - 点了个点点</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/rainbow.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.9","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":9},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>点</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="k8s">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-03-25 13:59" pubdate>
        March 25, 2022 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      14.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      187
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">k8s</h1>
            
            <div class="markdown-body">
              <h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h2><p>Kubernetes是一个基于 Docker 的容器集群管理系统，其目的是让用户透过 Kubernetes 集群来进行云端容器集群的管理</p>
<p><strong>它的本质是一组服务器</strong>（集群），可以在集群的每个节点运行特点的程序，来对节点中的容器进行管理。目的是为了实现资源管理的自动化</p>
<p>功能：</p>
<ul>
<li><p><strong>自我修复</strong>：一旦某个容器奔溃，能够迅速启动新的容器</p>
</li>
<li><p><strong>弹性伸缩</strong>：根据需要自动对集群中正在运行的容器调整数量</p>
</li>
<li><p><strong>服务发现</strong>：服务可以通过自动发现的形式找到它所依赖的服务</p>
</li>
<li><p><strong>负载均衡</strong>：如果（1000个）请求启动了多个（5个nginx）容器，能够自动实现请求的负载均衡</p>
</li>
<li><p><strong>版本回退</strong>：如果新发布的应用有问题，可以立即回退到原来的版本</p>
</li>
<li><p><strong>存储编排</strong>：根据容器自身的需求自动创建存储卷</p>
</li>
</ul>
<h2 id="2-组件"><a href="#2-组件" class="headerlink" title="2. 组件"></a>2. 组件</h2><p>一个k8s集群由**控制节点(master)<strong>、</strong>工作节点(node)**构成，每个节点上都会安装不同的组件</p>
<p><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.pianshen.com%2Fimages%2F551%2F4365abaae9bd1352624aa296cdeff097.png&refer=http%3A%2F%2Fwww.pianshen.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1641277393&t=3e3f93606c3db833bf5f77c9a842e890" srcset="/img/loading.gif" lazyload></p>
<p><strong>master：管理层，负责集群的决策</strong></p>
<ul>
<li><strong>API Server</strong>：集群管理操作的入口，不管是kubectl还是HTTP调用来操作Kubernetes集群各种资源，都是通过它的接口进行操作</li>
<li><strong>Scheduler</strong>：负责集群资源调度，根据调度策略将Pod调度到相应的node节点上</li>
<li><strong>ControllerManager</strong>：资源对象的控制自动化中心。即监控Node，当故障时转移资源对象，自动修复集群到期望状态。比如程序部署安排、故障检测、自动扩展等</li>
<li><strong>Etcd</strong>：负责存储集群中各种资源对象的信息。k8s启动后，master和node都会将自身的信息存储到etcd数据库中</li>
</ul>
<p><strong>node：工作层，负责为容器提供运行环境</strong></p>
<ul>
<li><strong>Kubelet</strong>： 负责Pod内容器的创建、启停。并与Master密切协作实现集群管理（注册自己，汇报Node状态）<ul>
<li>监听Scheduler组件的任务分配</li>
<li>挂载pod所需Volume</li>
<li>下载pod所需Secrets</li>
<li>通过与docker daemon的交互运行docker容器</li>
<li>监控、报告pod和node状态到ControllerManager组件</li>
</ul>
</li>
<li><strong>KubeProxy</strong>：负责提供集群内部的服务发现和负载均衡，负责将后端pod访问规则具体为节点上的iptables/ipvs规则</li>
<li><strong>Docker</strong>：负责镜像管理以及pod和容器的真正运行</li>
</ul>
<hr>
<p><strong>部署Nginx：</strong></p>
<ol>
<li>”安装nginx服务的请求“发送至master节点的<strong>API Server</strong>组件</li>
<li><strong>API Server</strong>调用<strong>Scheduler</strong>组件做出决定（选择哪个node节点）。它会从<strong>etcd</strong>中读取node节点信息，根据一定的算法进行选择，并将结果告诉<strong>API Server</strong></li>
<li><strong>API Server</strong>调用<strong>ControllerManager</strong>组件去安排这个决定（调度node节点安装nginx）</li>
<li><strong>ControllerManager</strong>将安排发送给<strong>Kubelet</strong>，<strong>Kubelet</strong>接受到指令后，会通知<strong>Docker</strong>，由<strong>Docker</strong>启动一个nginx的pod（pod是k8s的最小操作单元，容器必须跑在pod中）</li>
<li>nginx服务运行来了，如果需要访问，就需要通过<strong>KubeProxy</strong>来对pod产生访问的代理，这样外界用户可以访问集群中的nginx访问了</li>
</ol>
<blockquote>
<p>客户（用户）想要增加一个新功能，会联系项目经理（API Server），项目经理通过分析（Scheduler）得知谁来做这个功能，然后通知（ControllerManager）这个小组长（Kubelet），小组长再将工作告诉某个人（Docker）</p>
</blockquote>
<h2 id="3-概念"><a href="#3-概念" class="headerlink" title="3. 概念"></a>3. 概念</h2><p><strong>Master</strong>：集群控制节点，每个集群至少有一个master节点负责集群的管控</p>
<p><strong>Node</strong>：工作负载节点，由master节点分配容器到node工作节点上，node节点上的docker容器负责运行</p>
<p><strong>Pod</strong>：k8s的最小控制单元，容器运行在pod中，一个pod包含多个容器。通过控制pod进而控制容器</p>
<p><strong>Controller</strong>：pod控制器，通过它来实现对pod的管理，比如启动、停止</p>
<p><strong>Service</strong>：pod对外提供服务的统一入口，可以维护同一类的pod</p>
<p><strong>Label</strong>：标签，用于对pod进行分类</p>
<p><strong>Namespace</strong>：命名空间，用来隔离pod的运行环境</p>
<h1 id="二、资源管理"><a href="#二、资源管理" class="headerlink" title="二、资源管理"></a>二、资源管理</h1><p>在kubernetes中，所有的内容都抽象为资源，用户需要通过操作资源来管理kubernetes</p>
<blockquote>
<p>部署服务：在k8s集群中运行一个个的容器，并将指定的程序跑在容器中</p>
<p>k8s的最小管理单元是pod，所以容器要放在<strong>pod</strong>中，k8s并不直接管理<strong>pod</strong>，还是通过**pod控制器(Controller)**来管理pod</p>
<p>pod提供服务之后，就要访问服务了，这就是<strong>Service</strong>的功能</p>
</blockquote>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112070956420.png" srcset="/img/loading.gif" lazyload alt="image-20211207095642065"></p>
<blockquote>
<p>学习kubernetes的核心，就是学习如何对集群上的<strong>Pod、Pod控制器、Service、存储</strong>等资源进行操作</p>
</blockquote>
<h2 id="1-资源管理方式"><a href="#1-资源管理方式" class="headerlink" title="1.资源管理方式"></a>1.资源管理方式</h2><ul>
<li><p>命令式对象管理：使用命令去操作kubernetes资源</p>
<p><code>kubectl run nginx-pod --image=nginx:1.17.1 --port=80</code></p>
</li>
<li><p>命令式对象配置：使用命令 + 配置文件去操作kubernetes资源</p>
<p><code>kubectl create/patch -f nginx-pod.yml</code></p>
</li>
<li><p>声明式对象配置：通过<code>apply</code>（创建和更新的结合）命令和配置文件去操作kubernetes资源</p>
<p><code>kubectl apply -f nginx-pod.yml</code></p>
</li>
</ul>
<h2 id="2-命令式对象管理"><a href="#2-命令式对象管理" class="headerlink" title="2.命令式对象管理"></a>2.命令式对象管理</h2><p>kubectl是kubernetes集群的命令行工具，通过它对集群本身进行管理</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">kubectl [command] [type] [name] [flags]<br></code></pre></div></td></tr></table></figure>

<p><code>command</code>：指定要对资源执行的操作，比如create、get、delete</p>
<p><code>type</code>：指定资源类型，比如deployment、pod、service</p>
<p><code>name</code>：指定资源名称，大小写敏感</p>
<p><code>flags</code>：指定额外的可选参数</p>
<ul>
<li><code>-o</code>：格式化显示。-o=yaml，yaml格式显示结果；-o=wide，详细信息</li>
<li><code>-n/--namespace</code>：查看指定的命名空间，后跟 namespace</li>
<li><code>--images</code>：指定镜像</li>
<li><code>--port</code>：暴露端口</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">查看所有pod</span><br>kubectl get pod<br><span class="hljs-meta">#</span><span class="bash">查看某个pod</span><br>kubectl get pod pod_name<br><span class="hljs-meta">#</span><span class="bash">查看某个pod，yml输出</span><br>kubectl get pod pod_name -o=yml<br></code></pre></div></td></tr></table></figure>

<hr>
<h3 id="command操作"><a href="#command操作" class="headerlink" title="command操作"></a>command操作</h3><table>
<thead>
<tr>
<th align="left">命令分类</th>
<th align="left">命令</th>
<th align="left">翻译</th>
<th align="left">命令作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">基本命令</td>
<td align="left"><strong>create</strong></td>
<td align="left">创建</td>
<td align="left">创建一个资源</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">edit</td>
<td align="left">编辑</td>
<td align="left">编辑一个资源</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><strong>get</strong></td>
<td align="left">获取</td>
<td align="left">获取一个资源</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">patch</td>
<td align="left">更新</td>
<td align="left">更新一个资源</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><strong>delete</strong></td>
<td align="left">删除</td>
<td align="left">删除一个资源</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">explain</td>
<td align="left">解释</td>
<td align="left">展示资源文档</td>
</tr>
<tr>
<td align="left">运行和调试</td>
<td align="left"><strong>run</strong></td>
<td align="left">运行</td>
<td align="left">在集群中运行一个指定的镜像</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><strong>expose</strong></td>
<td align="left">暴露</td>
<td align="left">暴露资源为Service</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><strong>describe</strong></td>
<td align="left">描述</td>
<td align="left">显示资源内部信息</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><strong>logs</strong></td>
<td align="left">日志输出容器在 pod 中的日志</td>
<td align="left">输出容器在 pod 中的日志</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">attach</td>
<td align="left">缠绕进入运行中的容器</td>
<td align="left">进入运行中的容器</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">exec</td>
<td align="left">执行容器中的一个命令</td>
<td align="left">执行容器中的一个命令</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">cp</td>
<td align="left">复制</td>
<td align="left">在Pod内外复制文件</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">rollout</td>
<td align="left">首次展示</td>
<td align="left">管理资源的发布</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><strong>scale</strong></td>
<td align="left">规模</td>
<td align="left">扩(缩)容Pod的数量</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">autoscale</td>
<td align="left">自动调整</td>
<td align="left">自动调整Pod的数量</td>
</tr>
<tr>
<td align="left">高级命令</td>
<td align="left">apply</td>
<td align="left">create/patch</td>
<td align="left">通过文件对资源进行配置</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">label</td>
<td align="left">标签</td>
<td align="left">更新资源上的标签</td>
</tr>
<tr>
<td align="left">其他命令</td>
<td align="left">cluster-info</td>
<td align="left">集群信息</td>
<td align="left">显示集群信息</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">version</td>
<td align="left">版本</td>
<td align="left">显示当前Server和Client的版本</td>
</tr>
</tbody></table>
<hr>
<h3 id="type资源"><a href="#type资源" class="headerlink" title="type资源"></a>type资源</h3><p>kubernetes中所有的内容都抽象为资源，可以通过下面的命令进行查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">kubectl api-resources<br></code></pre></div></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">资源分类</th>
<th align="left">资源名称</th>
<th align="left">缩写</th>
<th align="left">资源作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">集群级别资源</td>
<td align="left">nodes</td>
<td align="left">no</td>
<td align="left">集群组成部分</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">namespaces</td>
<td align="left">ns</td>
<td align="left">隔离Pod</td>
</tr>
<tr>
<td align="left">pod资源</td>
<td align="left">pods</td>
<td align="left">po</td>
<td align="left">装载容器</td>
</tr>
<tr>
<td align="left">pod资源控制器</td>
<td align="left">replicationcontrollers</td>
<td align="left">rc</td>
<td align="left">控制pod资源</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">replicasets</td>
<td align="left">rs</td>
<td align="left">控制pod资源</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">deployments</td>
<td align="left">deploy</td>
<td align="left">控制pod资源</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">daemonsets</td>
<td align="left">ds</td>
<td align="left">控制pod资源</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">jobs</td>
<td align="left"></td>
<td align="left">控制pod资源</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">cronjobs</td>
<td align="left">cj</td>
<td align="left">控制pod资源</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">horizontalpodautoscalers</td>
<td align="left">hpa</td>
<td align="left">控制pod资源</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">statefulsets</td>
<td align="left">sts</td>
<td align="left">控制pod资源</td>
</tr>
<tr>
<td align="left">服务发现资源</td>
<td align="left">services</td>
<td align="left">svc</td>
<td align="left">统一pod对外接口</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">ingress</td>
<td align="left">ing</td>
<td align="left">统一pod对外接口</td>
</tr>
<tr>
<td align="left">存储资源</td>
<td align="left">volumeattachments</td>
<td align="left"></td>
<td align="left">存储</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">persistentvolumes</td>
<td align="left">pv</td>
<td align="left">存储</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">persistentvolumeclaims</td>
<td align="left">pvc</td>
<td align="left">存储</td>
</tr>
<tr>
<td align="left">配置资源</td>
<td align="left">configmaps</td>
<td align="left">cm</td>
<td align="left">配置</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">secrets</td>
<td align="left"></td>
<td align="left">配置</td>
</tr>
</tbody></table>
<hr>
<p>下面以一个namespace / pod的创建和删除简单演示下命令的使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 创建一个namespace，名为dev</span><br>[root@master ~]# kubectl create namespace dev<br>namespace/dev created<br><br><span class="hljs-meta">#</span><span class="bash"> 获取namespace</span><br>[root@master ~]# kubectl get ns<br>NAME              STATUS   AGE<br>default           Active   21h<br>dev               Active   21s<br>kube-node-lease   Active   21h<br>kube-public       Active   21h<br>kube-system       Active   21h<br><br><span class="hljs-meta">#</span><span class="bash"> 在此namespace下创建并运行一个nginx的Pod</span><br>[root@master ~]# kubectl run pod --image=nginx:latest -n dev<br><br><span class="hljs-meta">#</span><span class="bash"> 查看namespace下的pod,不加-n dev默认查询-n default</span><br>[root@master ~]# kubectl get pod -n dev<br>NAME  READY   STATUS    RESTARTS   AGE<br>pod   1/1     Running   0          21s<br><br><span class="hljs-meta">#</span><span class="bash"> 删除指定的pod</span><br>[root@master ~]# kubectl delete pod pod-864f9875b9-pcw7x<br>pod &quot;pod&quot; deleted<br><br><span class="hljs-meta">#</span><span class="bash"> 删除指定的namespace</span><br>[root@master ~]# kubectl delete ns dev<br>namespace &quot;dev&quot; deleted<br></code></pre></div></td></tr></table></figure>

<h2 id="3-命令式对象配置"><a href="#3-命令式对象配置" class="headerlink" title="3.命令式对象配置"></a>3.命令式对象配置</h2><p><strong>命令式对象管理</strong>使用命令 + 各种参数</p>
<p><strong>命令式对象配置</strong>使用命令 + 配置文件，配置文件写的就是各种参数</p>
<ol>
<li><p>创建一个nginx-pod.yaml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-comment"># 创建namespace  dev</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">dev</span><br><br><span class="hljs-comment"># ---分割文件，这是yaml的语法</span><br><span class="hljs-meta">---</span><br><br><span class="hljs-comment"># 创建pod 名为nginxpod，命名空间为上一步创建的dev</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginxpod</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span><br><span class="hljs-attr">spec:</span><br><span class="hljs-comment"># 和docker差不多，指定容器名和镜像源</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-containers</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br></code></pre></div></td></tr></table></figure></li>
<li><p>执行create命令，创建资源</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@master ~]# kubectl create -f nginxpod.yaml<br>namespace/dev created<br>pod/nginxpod created<br></code></pre></div></td></tr></table></figure></li>
<li><p>执行get命令，查看资源</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">查看namespace</span><br>[root@master ~]#  kubectl get ns dev<br><span class="hljs-meta">#</span><span class="bash">查看pod</span><br>[root@master ~]#  kubectl get pod -n dev<br><br><span class="hljs-meta">#</span><span class="bash">一起查看，通过nginxpod.yaml</span><br>[root@master ~]#  kubectl get -f nginxpod.yaml<br></code></pre></div></td></tr></table></figure></li>
<li><p>执行delete命令，删除资源</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@master ~]# kubectl delete -f nginxpod.yaml<br>namespace &quot;dev&quot; deleted<br>pod &quot;nginxpod&quot; deleted<br></code></pre></div></td></tr></table></figure></li>
</ol>
<h2 id="4-声明式对象配置"><a href="#4-声明式对象配置" class="headerlink" title="4.声明式对象配置"></a>4.声明式对象配置</h2><p>只有一个命令<code>apply</code></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 首先执行一次kubectl apply -f yaml文件，发现创建了资源</span><br>[root@master ~]#  kubectl apply -f nginxpod.yaml<br>namespace/dev created<br>pod/nginxpod created<br><br><span class="hljs-meta">#</span><span class="bash"> 再次执行一次kubectl apply -f yaml文件，发现说资源没有变动</span><br>[root@master ~]#  kubectl apply -f nginxpod.yaml<br>namespace/dev unchanged<br>pod/nginxpod unchanged<br></code></pre></div></td></tr></table></figure>

<p>声明式对象配置就是使用<code>apply</code>描述一个资源最终的状态（在yaml中定义状态）<br>使用<code>apply</code>操作资源：<br>        如果资源不存在，就创建，相当于<code>kubectl create</code><br>        如果资源已存在，就更新，相当于<code>kubectl patch</code></p>
<h1 id="三、Namespace"><a href="#三、Namespace" class="headerlink" title="三、Namespace"></a>三、Namespace</h1><p>默认情况下，Pod是可以相互访问的，如果不想让两个Pod之间互相访问，就可以将两个Pod划分到不同的namespace下。k8s通过将集群内部的资源分配到不同的namespace中，形成逻辑上的组，方便不同的组的资源进行隔离使用和管理</p>
<p>可以通过kubernetes的授权机制，将不同的namespace交给不同租户进行管理，这样就实现了多租户的资源隔离。此时还能结合kubernetes的资源配额机制，限定不同租户能占用的资源，例如CPU使用量、内存使用量等等，来实现租户可用资源的管理</p>
<p><strong>命令方式</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 查看</span><br><span class="hljs-meta">#</span><span class="bash"> Active 命名空间正在使用中  Terminating 正在删除命名空间</span><br><span class="hljs-meta">[root@master]#</span><span class="bash"> kubectl  get namespace</span><br>NAME              STATUS   AGE<br>default           Active   45h     #  所有未指定Namespace的对象都会被分配在default命名空间<br>kube-node-lease   Active   45h     #  集群节点之间的心跳维护，v1.13开始引入<br>kube-public       Active   45h     #  此命名空间下的资源可以被所有人访问（包括未认证用户）<br>kube-system       Active   45h     #  所有由Kubernetes系统创建的资源都处于这个命名空间<br><br><span class="hljs-meta">#</span><span class="bash"> 创建</span><br><span class="hljs-meta">[root@master]#</span><span class="bash"> kubectl create ns njm</span><br>namespace/njm created<br><br><span class="hljs-meta">#</span><span class="bash"> 删除</span><br><span class="hljs-meta">[root@master]#</span><span class="bash"> kubectl delete ns njm</span><br>namespace &quot;njm&quot; deleted<br></code></pre></div></td></tr></table></figure>

<p><strong>配置方式</strong></p>
<p>ns-dev.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">dev</span><br></code></pre></div></td></tr></table></figure>

<p>创建和删除命令</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">kubectl create -f ns-dev.yaml<br>kubectl delete -f ns-dev.yaml<br></code></pre></div></td></tr></table></figure>

<h1 id="四、Label"><a href="#四、Label" class="headerlink" title="四、Label"></a>四、Label</h1><p>在资源上添加标识，用来对它们进行区分和选择。在后续的pod控制器和Service都是通过label来管理pod</p>
<blockquote>
<p>namespace可以实现环境隔离，比如隔离dev环境和test环境。而dev环境下又有前端和后端项目，前后端项目之间需要通信，所以不能用namespace，就需要使用Label</p>
<p>namespace隔离了pod, 所以通过label分组,但不隔离</p>
</blockquote>
<p>特点：</p>
<ul>
<li>一个Label会以key/value键值对的形式附加到各种对象上，如Node、Pod、Service等</li>
<li>一个资源对象可以定义任意数量的Label ，同一个Label也可以被添加到任意数量的资源对象上去</li>
<li>Label通常在资源对象定义时确定，也可以在对象创建后动态添加或者删除</li>
</ul>
<hr>
<p>标签定义完毕之后，还要考虑到标签的选择，这就要使用到Label Selector</p>
<p>Label用于给某个资源对象定义标识</p>
<p>Label Selector用于查询指定标签的资源对象</p>
<ul>
<li>基于等式的Label Selector：name=slave</li>
<li>基于集合的Label Selector：name in (master,slave)</li>
</ul>
<p><strong>命令方式</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 打标签  kubectl label 资源类型 资源名 标签</span> <br>[root@master ~]# kubectl label pod nginx-pod -n dev version=1.0<br>pod/nginx-pod labeled<br><br><span class="hljs-meta">#</span><span class="bash"> 查看标签--show-labels</span><br>[root@master ~]# kubectl get pod nginx-pod  -n dev --show-labels<br>NAME        READY   STATUS    RESTARTS   AGE   LABELS<br>nginx-pod   1/1     Running   0          10m   version=1.0<br><br><span class="hljs-meta">#</span><span class="bash"> 修改标签--overwrite</span><br>[root@master ~]# kubectl label pod nginx-pod version=2.0 -n dev --overwrite<br>pod/nginx-pod labeled<br><br><span class="hljs-meta">#</span><span class="bash"> 筛选pod，根据标签</span><br>[root@master ~]# kubectl get pod -n dev -l version=2.0 --show-labels<br><br><span class="hljs-meta">#</span><span class="bash"> 删除标签  标签名-</span><br>[root@master ~]# kubectl label pod nginx-pod -n dev version-<br></code></pre></div></td></tr></table></figure>

<p><strong>配置方式</strong></p>
<p>pod-nginx.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3.0&quot;</span> <br>    <span class="hljs-attr">env:</span> <span class="hljs-string">&quot;test&quot;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">pod</span><br>    <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-port</span><br>      <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br></code></pre></div></td></tr></table></figure>

<p>执行命令：<code>kubectl apply -f pod-nginx.yaml </code></p>
<h1 id="五、Pod"><a href="#五、Pod" class="headerlink" title="五、Pod"></a>五、Pod</h1><h2 id="1-入门"><a href="#1-入门" class="headerlink" title="1.入门"></a>1.入门</h2><p>Pod是kubernetes集群进行管理的最小单元，程序要运行必须部署在容器中，而容器必须存在于Pod中</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112071433991.png" srcset="/img/loading.gif" lazyload alt="image-20211207143321015"></p>
<p>Pod可以认为是容器的封装，Pod中可包含一个或多个容器，容器可分为两类</p>
<ul>
<li>用户程序定义的容器</li>
<li>Pause容器。这是每个Pod都会有的一个<strong>根容器</strong>，作用：<ul>
<li>以它为依据，评估整个Pod的健康状态</li>
<li>可以在根容器设置ip地址，其他容器共享此ip，实现Pod内部网络通讯</li>
</ul>
</li>
</ul>
<hr>
<p><strong>查看Pod</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> -n kube-system 查看命名空间为kube-system的pod</span> <br>kubectl get pod -n kube-system<br></code></pre></div></td></tr></table></figure>

<p><strong>创建并运行</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 命令格式： kubectl run (pod名称) [参数]</span> <br><span class="hljs-meta">#</span><span class="bash"> --image  指定Pod的镜像</span><br><span class="hljs-meta">#</span><span class="bash"> --port   指定端口</span><br><span class="hljs-meta">#</span><span class="bash"> --namespace  指定namespace</span><br><br><span class="hljs-meta">#</span><span class="bash"> 运行一个名称为nginx的pod</span><br>[root@master ~]# kubectl run nginx --image=nginx:latest --port=80 --namespace dev <br>pod/nginx created<br></code></pre></div></td></tr></table></figure>

<p><strong>查看Pod</strong>，注意要加上命名空间</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 查看Pod基本信息</span><br>[root@master ~]# kubectl get pod -n dev<br>NAME    READY   STATUS    RESTARTS   AGE<br>nginx   1/1     Running   0          43s<br><br><span class="hljs-meta">#</span><span class="bash"> 查看Pod的详细信息</span><br>[root@master ~]# kubectl describe pod nginx -n dev<br></code></pre></div></td></tr></table></figure>

<p><strong>删除Pod</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@master ~]# kubectl delete pod nginx -n dev<br></code></pre></div></td></tr></table></figure>

<hr>
<p><strong>通过配置文件操作</strong></p>
<p>nginx-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br><span class="hljs-comment"># 这个name指的是pod</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">pod</span><br>    <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-port</span><br>      <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br></code></pre></div></td></tr></table></figure>

<p>创建和删除命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">kubectl create -f nginx-pod.yaml<br>kubectl delete -f nginx-pod.yaml<br></code></pre></div></td></tr></table></figure>

<hr>
<h2 id="2-配置"><a href="#2-配置" class="headerlink" title="2.配置"></a>2.配置</h2><p><strong>可以使用explain查看某种类型的可配置项</strong></p>
<p><code>kebectl explain 资源类型</code>     查看一级属性</p>
<p><code>kebectl explain 资源类型.属性</code>    查看属性的子属性</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@k8s-master01 ~]# kubectl explain pod<br>KIND:     Pod<br>VERSION:  v1<br>FIELDS:		#一级属性<br>   apiVersion   &lt;string&gt;<br>   kind &lt;string&gt;<br>   metadata     &lt;Object&gt;<br>   spec &lt;Object&gt;<br>   status       &lt;Object&gt;<br>[root@k8s-master01 ~]# kubectl explain pod.metadata<br>KIND:     Pod<br>VERSION:  v1<br>RESOURCE: metadata &lt;Object&gt;<br>FIELDS:		# pod的metadate属性<br>   annotations  &lt;map[string]string&gt;<br>   clusterName  &lt;string&gt;<br>   creationTimestamp    &lt;string&gt;<br>   deletionGracePeriodSeconds   &lt;integer&gt;<br>   deletionTimestamp    &lt;string&gt;<br>   finalizers   &lt;[]string&gt;<br>   generateName &lt;string&gt;<br>   generation   &lt;integer&gt;<br>   labels       &lt;map[string]string&gt;<br>   managedFields        &lt;[]Object&gt;<br>   name &lt;string&gt;<br>   namespace    &lt;string&gt;<br>   ownerReferences      &lt;[]Object&gt;<br>   resourceVersion      &lt;string&gt;<br>   selfLink     &lt;string&gt;<br>   uid  &lt;string&gt;<br></code></pre></div></td></tr></table></figure>

<p>一级属性：</p>
<ul>
<li>apiVersion <string> ：版本，由k8s内部定义，版本号必须可以用 <code>kubectl api-versions</code> 查询到</li>
<li>kind <string> ：资源类型，由k8s内部定义，版本号必须可以用 <code>kubectl api-resources</code> 查询到</li>
<li>metadata <Object> ：元数据，主要是资源标识和说明，常用的有name、namespace、labels等</li>
<li><strong>spec <Object> ：描述</strong>，这是配置中最重要的一部分，里面是对各种资源配置的详细描述</li>
<li>status <Object> ：状态信息，不需要定义，由k8s自动生成</li>
</ul>
<p>spec的常见子属性：</p>
<ul>
<li><p>containers &lt;[]Object&gt;：容器列表，定义容器的详细信息</p>
</li>
<li><p>nodeName &lt;[]Object&gt;：根据nodeName将pod调度至指定的Node节点上 </p>
</li>
<li><p>nodeSelector &lt;map[]&gt;：根据NodeSelector（标签）将pod调度到包含这些label的Node节点上</p>
</li>
<li><p>hostNetwork <boolean> ：是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</p>
</li>
<li><p>volumes &lt;[]Object&gt; 存储卷，用于定义Pod上面挂在的存储信息</p>
</li>
<li><p>restartPolicy <string> 重启策略，表示Pod在遇到故障的时候的处理策略</p>
</li>
</ul>
<hr>
<h3 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h3><blockquote>
<p>2.配置中介绍的都是containers 的子属性</p>
</blockquote>
<p><code>pod.spec.containers </code>属性</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@k8s-master01 ~]# kubectl explain pod.spec.containers<br>KIND:     Pod<br>VERSION:  v1<br>RESOURCE: containers &lt;[]Object&gt;   # 数组，代表可以有多个容器<br>FIELDS:<br>   name  &lt;string&gt;     # 容器名称<br>   image &lt;string&gt;     # 容器需要的镜像地址<br>   imagePullPolicy  &lt;string&gt; # 镜像拉取策略 <br>   command  &lt;[]string&gt; # 容器的启动命令列表，如不指定，使用打包时使用的启动命令<br>   args     &lt;[]string&gt; # 容器的启动命令需要的参数列表<br>   env      &lt;[]Object&gt; # 容器环境变量的配置<br>   ports    &lt;[]Object&gt;     # 容器需要暴露的端口号列表<br>   resources &lt;Object&gt;      # 资源限制和资源请求的设置<br></code></pre></div></td></tr></table></figure>

<p><strong>创建pod-base.yaml文件</strong></p>
<p>创建pod，名为pod-base，命名空间为dev，标签user:niujiaming。创建了两个容器</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-base</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">niujiaming</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx01</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx02</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br></code></pre></div></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 创建Pod</span><br>[root@k8s-master01 pod]# kubectl apply -f pod-base.yaml<br>pod/pod-base created<br><br><span class="hljs-meta">#</span><span class="bash"> 查看Pod状况</span><br>[root@k8s-master01 pod]# kubectl get pod -n dev<br><br><span class="hljs-meta">#</span><span class="bash"> 可以通过describe查看内部的详情</span><br>[root@k8s-master01 pod]# kubectl describe pod pod-base -n dev<br></code></pre></div></td></tr></table></figure>

<h3 id="镜像拉取策略"><a href="#镜像拉取策略" class="headerlink" title="镜像拉取策略"></a>镜像拉取策略</h3><p>创建pod-imagepullpolicy.yaml文件</p>
<p>imagePullPolicy，用于设置镜像拉取策略</p>
<ul>
<li>Always：一直远程下载</li>
<li>IfNotPresent：本地有就本地 本地没远程下载</li>
<li>Never：一直使用本地</li>
</ul>
<blockquote>
<p>如果镜像tag为具体版本号，拉取策略为IfNotPresent</p>
<p>如果没有镜像tag（默认latest），拉取策略为Always</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-imagepullpolicy</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>    <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">Never</span> <span class="hljs-comment"># 本地拉取，没有就失败</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx02</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br></code></pre></div></td></tr></table></figure>

<h3 id="启动命令"><a href="#启动命令" class="headerlink" title="启动命令"></a>启动命令</h3><p>用于在pod中的容器初始化完毕之后运行一个命令</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: pod-command<br>  namespace: dev<br>spec:<br>  containers:<br>  - name: busybox<br>    image: busybox:1.30<br>    command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done;&quot;]<br></code></pre></div></td></tr></table></figure>

<blockquote>
<p>“/bin/sh”,”-c”, 使用sh执行命令</p>
<p>touch /tmp/hello.txt; 创建一个/tmp/hello.txt 文件</p>
<p>while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done; 每隔3秒向文件中写入当前时间</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 创建Pod</span><br>[root@k8s-master01 pod]# kubectl create  -f pod-command.yaml<br><br><span class="hljs-meta">#</span><span class="bash"> 进入pod中的busybox容器，查看文件内容</span><br><span class="hljs-meta">#</span><span class="bash"> kubectl <span class="hljs-built_in">exec</span>  pod名称 -n 命名空间 -it -c 容器名称 /bin/sh  在容器内部执行的命令</span><br><span class="hljs-meta">#</span><span class="bash"> 使用这个命令就可以进入某个容器的内部，然后进行相关操作了</span><br><span class="hljs-meta">#</span><span class="bash"> 比如，可以查看txt文件的内容</span><br>[root@k8s-master01 pod]# kubectl exec pod-command -n dev -it -c busybox /bin/sh<br>/ # tail -f /tmp/hello.txt<br>14:44:19<br>14:44:22<br>14:44:25<br></code></pre></div></td></tr></table></figure>

<p><strong>args</strong></p>
<p>command已经可以完成启动命令和传递参数的功能，为什么这里还要提供一个args选项，用于传递参数呢?这其实跟docker有点关系，kubernetes中的command、args两项其实是实现覆盖Dockerfile中ENTRYPOINT的功能。</p>
<ol>
<li>如果command和args均没有写，那么用Dockerfile的配置。</li>
<li>如果command写了，但args没有写，那么Dockerfile默认的配置会被忽略，执行输入的command</li>
<li>如果command没写，但args写了，那么Dockerfile中配置的ENTRYPOINT的命令会被执行，使用当前args的参数</li>
<li> 如果command和args都写了，那么Dockerfile的配置被忽略，执行command并追加上args参数</li>
</ol>
<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>env，用于在pod容器中设计环境变量</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">envar-demo</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">purpose:</span> <span class="hljs-string">demonstrate-envars</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">envar-demo-container</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">gcr.io/google-samples/node-hello:1.0</span><br>    <span class="hljs-attr">env:</span><br>    <span class="hljs-comment"># 定义一个名为DEMO_GREETING值为&quot;Hello from the environment&quot;的环境变量</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DEMO_GREETING</span><br>      <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;Hello from the environment&quot;</span><br></code></pre></div></td></tr></table></figure>

<p>运行后使用<code>kubectl exec -it envar-demo -- /bin/bash</code>进入容器中，使用<code>printenv</code>查看环境变量</p>
<h3 id="端口设置"><a href="#端口设置" class="headerlink" title="端口设置"></a>端口设置</h3><p>ports支持的子选项</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@k8s-master ~]# kubectl explain pod.spec.containers.ports<br>KIND:     Pod<br>VERSION:  v1<br>RESOURCE: ports &lt;[]Object&gt;<br>FIELDS:<br>   containerPort&lt;integer&gt;	#容器端口。必填，容器要监听的端口<br>   hostIP       &lt;string&gt;	#主机IP。要将外部端口绑定到主机IP，一般省略<br>   hostPort     &lt;integer&gt;	#主机端口。容器要在主机上公开的端口，一般省略<br>   name			&lt;string&gt;	#端口名字<br>   protocol     &lt;string&gt;	#端口协议，默认TCP<br></code></pre></div></td></tr></table></figure>

<p>pod-ports.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-ports</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.10</span><br>    <span class="hljs-attr">ports:</span> <span class="hljs-comment"># 设置容器暴露的端口列表</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-port</span><br>      <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br></code></pre></div></td></tr></table></figure>

<h3 id="资源配额"><a href="#资源配额" class="headerlink" title="资源配额"></a>资源配额</h3><p>程序运行要占用资源，如果不对某个容器的资源做限制，那么它就可能吃掉大量资源，导致其他容器无法运行。k8s通过<strong>resources</strong>选项实现资源分配，它有两个子选项规定容器的上下限：</p>
<ul>
<li><p>requets：下限。设置容器需要的最小资源，不够不启动容器</p>
</li>
<li><p>limits：上限。限制运行时容器的最大占用资源，超过就重启容器</p>
</li>
</ul>
<p>pod-resources.yaml</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: pod-resources<br>  namespace: dev<br>spec:<br>  containers:<br>  - name: nginx<br>    image: nginx:1.17.1<br>    resources: # 资源配额<br>      limits:  # 限制资源（上限）<br>        cpu: &quot;2&quot; # CPU限制，单位是core数<br>        memory: &quot;10Gi&quot; #内存大小，可以使用Gi、Mi、G、M等形式<br>      requests: # 请求资源（下限）<br>        cpu: &quot;1&quot;<br>        memory: &quot;10Mi&quot; <br></code></pre></div></td></tr></table></figure>

<h2 id="3-生命周期"><a href="#3-生命周期" class="headerlink" title="3.生命周期"></a>3.生命周期</h2><p>pod对象从<strong>创建到终止</strong>的这段时间范围称为pod的生命周期，包括：</p>
<ul>
<li>pod创建过程</li>
<li>运行初始化容器（init container）过程</li>
<li>运行主容器（main container 用户容器）过程<ul>
<li>容器启动后钩子（post start）、容器终止前钩子（pre stop）</li>
<li>容器的存活性探测（liveness probe）、就绪性探测（readiness  probe）</li>
</ul>
</li>
<li>pod终止过程</li>
</ul>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112131508755.png" srcset="/img/loading.gif" lazyload alt="image-20211213150831069"></p>
<p>在整个生命周期中，Pod会出现5种<strong>状态</strong>（<strong>相位</strong>），分别如下：</p>
<ul>
<li>挂起（Pending）：apiserver已经创建了pod资源对象，但它尚未被调度完成或者仍处于下载镜像的过程中</li>
<li>运行中（Running）：pod已经被调度至某节点，并且所有容器都已经被kubelet创建完成</li>
<li>成功（Succeeded）：pod中的所有容器都已经成功终止并且不会被重启</li>
<li>失败（Failed）：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非0值的退出状态</li>
<li>未知（Unknown）：apiserver无法正常获取到pod对象的状态信息，通常由网络通信失败所导致</li>
</ul>
<h3 id="创建和终止"><a href="#创建和终止" class="headerlink" title="创建和终止"></a>创建和终止</h3><p><strong>pod的创建过程</strong></p>
<ol>
<li>用户通过<code>kubectl</code>提交要创建的pod信息给<code>apiServer</code></li>
<li><code>apiServer</code>生成pod对象信息并存入etcd，然后确认信息</li>
<li><code>apiServer</code>开始反应etcd中pod对象的变化，其他组件使用watch机制来跟踪检查<code>apiService</code>上的变动</li>
<li><code>scheduler</code>发现有新的pod要创建，为pod分配主机并将结果更新给<code>apiServer</code></li>
<li>node节点的<code>kubectl</code>发现有pod调度过来，尝试用docker启动容器，并将结果返回给<code>apiServer</code></li>
<li><code>apiServer</code>将接收到的pod状态信息存入etcd中</li>
</ol>
<p><strong>pod的终止过程</strong></p>
<ol>
<li>用户通过<code>kubectl</code>提交要删除的pod信息给<code>apiServer</code></li>
<li>在删除前需要停止容器，在宽限期内（默认30s），pod被视为dead</li>
<li>将pod标记为terminating状态</li>
<li><code>kubectl</code>监控到pod处于terminating状态，同时启动pod关闭过程 </li>
<li>端点控制器监控到pod对象的关闭行为时将其从所有匹配到此端点的service资源的端点列表中移除</li>
<li>如果pod定义了preStop钩子处理器，则在其标记为terminating后会以同步的方式启动执行</li>
<li>pod容器进程收到停止信号</li>
<li>宽限期结束后，若pod还存在运行的进程，那么pod对象会收到立即终止的信号</li>
<li><code>kubectl</code>请求<code>apiServer</code>将此pod资源的宽限期设置为0从而完成删除</li>
</ol>
<h3 id="初始化容器"><a href="#初始化容器" class="headerlink" title="初始化容器"></a>初始化容器</h3><p>初始化容器不是一个动作，而是在pod主容器启动之前要运行的容器，主要是做一些主容器的前置工作（比如环境），具有两大特征：</p>
<ol>
<li>初始化容器必须运行完成直至结束，若某初始化容器运行失败，那么k8s需要重启它直到成功完成</li>
<li>初始化容器必须按照定义的顺序执行，当前一个成功后，后面的一个才能运行（初始化容器有多个）</li>
</ol>
<p>初始化容器有很多的应用场景，比如：</p>
<ul>
<li>提供主容器镜像中不具备的工具程序或自定义代码</li>
<li>初始化容器要先于应用容器串行启动并运行成功，可用于延后应用容器的启动（类似DockerCompose中的depends_on依赖关系）</li>
</ul>
<hr>
<p>pod-initcontainer.yaml</p>
<blockquote>
<p>initContainers属性和containers是同级的</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-initcontainer</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">main-container</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>    <span class="hljs-attr">ports:</span> <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-port</span><br>      <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>  <span class="hljs-attr">initContainers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">xxxx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">xxxx</span><br></code></pre></div></td></tr></table></figure>

<h3 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h3><p>钩子函数能够感知自身生命周期中的事件，并在相应的时刻到来时运行用户指定的程序代码。</p>
<blockquote>
<p>类似初始化容器，不过初始化容器的单位是容器，容器启动成功则继续，而这个是函数</p>
</blockquote>
<p>kubernetes在主容器的<strong>启动之后</strong>和<strong>停止之前</strong>提供了两个钩子函数：</p>
<ul>
<li>post start：容器<strong>创建之后</strong>执行，如果失败了会重启容器</li>
<li>pre stop ：容器<strong>终止之前</strong>执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</li>
</ul>
<p>钩子处理器提供了三种方式定义动作：</p>
<ol>
<li><p>Exec命令：在容器内执行一次命令</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">lifecycle:</span><br>  <span class="hljs-attr">postStart:</span> <br>    <span class="hljs-attr">exec:</span><br>      <span class="hljs-attr">command:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">cat</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/tmp/healthy</span><br></code></pre></div></td></tr></table></figure></li>
<li><p>TCPSocket：在当前容器尝试访问指定的socket</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">lifecycle:</span><br>  <span class="hljs-attr">postStart:</span><br>    <span class="hljs-attr">tcpSocket:</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br></code></pre></div></td></tr></table></figure></li>
<li><p>HTTPGet：在当前容器中向某url发起http请求</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">lifecycle:</span><br>  <span class="hljs-attr">postStart:</span><br>    <span class="hljs-attr">httpGet:</span><br>      <span class="hljs-attr">path:</span> <span class="hljs-string">/</span> <span class="hljs-comment">#URI地址</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span> <span class="hljs-comment">#端口号</span><br>      <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.70</span><span class="hljs-number">.28</span> <span class="hljs-comment">#主机地址</span><br>      <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span> <span class="hljs-comment">#支持的协议，http或者https</span><br>      <span class="hljs-comment">#拼起来就是http://192.168.70.28:80</span><br></code></pre></div></td></tr></table></figure></li>
</ol>
<p><strong>exec</strong>例子</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-hook-exec</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">main-container</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>    <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-port</span><br>      <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">lifecycle:</span><br>      <span class="hljs-attr">postStart:</span> <br>        <span class="hljs-attr">exec:</span> <span class="hljs-comment"># 在容器启动的时候执行一个命令，修改掉nginx的默认首页内容</span><br>          <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;echo postStart... &gt; /usr/share/nginx/html/index.html&quot;</span>]<br>      <span class="hljs-attr">preStop:</span><br>        <span class="hljs-attr">exec:</span> <span class="hljs-comment"># 在容器停止之前停止nginx服务</span><br>          <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;/usr/sbin/nginx&quot;</span>,<span class="hljs-string">&quot;-s&quot;</span>,<span class="hljs-string">&quot;quit&quot;</span>]<br></code></pre></div></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">[root@k8s-master hook-test]<span class="hljs-comment"># kubectl create -f pod-hook-exec.yaml </span><br>pod/pod-hook-exec created<br>[root@k8s-master hook-test]<span class="hljs-comment"># kubectl get pod -n njm -o wide</span><br>NAME            READY   STATUS    RESTARTS   AGE   IP             NODE            NOMINATED NODE   READINESS GATES<br>pod-hook-exec   1/1     Running   0          15s   172.29.16.32   192.168.70.28   &lt;none&gt;           &lt;none&gt;<br>[root@k8s-master hook-test]<span class="hljs-comment"># curl 172.29.16.32:80</span><br>postStart...<br></code></pre></div></td></tr></table></figure>

<h3 id="容器探测"><a href="#容器探测" class="headerlink" title="容器探测"></a>容器探测</h3><p>容器探测用于检测容器中的应用实例是否正常工作，是保障业务可用性的一种传统机制。如果经过探测，实例的状态不符合预期，那么kubernetes就会把该问题实例” 摘除 “，不承担业务流量。kubernetes提供了两种探针来实现容器探测，分别是：</p>
<ul>
<li>liveness probes：存活性探针，用于检测应用实例当前是否处于<strong>正常运行状态</strong>，如果不是，k8s会重启容器</li>
<li>readiness probes：就绪性探针，用于检测应用实例当前是否可以<strong>接收请求</strong>，如果不能，k8s不会转发流量（ready 变y为i加ness）</li>
</ul>
<blockquote>
<p>livenessProbe 决定是否重启容器</p>
<p>readinessProbe 决定是否将请求转发给容器</p>
</blockquote>
<p>探针方式：</p>
<ul>
<li><p>Exec命令：在容器内执行一次命令，如果命令执行的退出码为0，则认为程序正常，否则不正常</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">livenessProbe:</span><br>  <span class="hljs-attr">exec:</span><br>    <span class="hljs-attr">command:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">cat</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/tmp/healthy</span><br></code></pre></div></td></tr></table></figure></li>
<li><p>TCPSocket：将会尝试访问一个用户容器的端口，如果能够建立这条连接，则认为程序正常，否则不正常</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">livenessProbe:</span><br>  <span class="hljs-attr">tcpSocket:</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br></code></pre></div></td></tr></table></figure></li>
<li><p>HTTPGet：调用容器内Web应用的URL，如果返回的状态码在200和399之间，则认为程序正常，否则不正常</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">livenessProbe:</span><br>  <span class="hljs-attr">httpGet:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/</span> <span class="hljs-comment">#URI地址</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span> <span class="hljs-comment">#端口号</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-comment">#主机地址</span><br>    <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span> <span class="hljs-comment">#支持的协议，http或者https</span><br></code></pre></div></td></tr></table></figure></li>
</ul>
<p><strong>liveness probes（存活性探针）例子</strong></p>
<ol>
<li><p><strong>Exec命令</strong>  pod-liveness-exec.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-liveness-exec</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">ports:</span> <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-port</span><br>      <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">livenessProbe:</span><br>      <span class="hljs-attr">exec:</span><br>        <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;/bin/cat&quot;</span>,<span class="hljs-string">&quot;/tmp/hello.txt&quot;</span>] <span class="hljs-comment"># 执行一个查看文件的命令(这个文并不存在)</span><br></code></pre></div></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">创建</span><br>[root@k8s-master probes-test]# kubectl create -f pod-liveness-test.yaml <br>pod/pod-liveness-exec created<br><br><span class="hljs-meta">#</span><span class="bash">查看，RESTARTS重启了一次</span><br>[root@k8s-master probes-test]# kubectl get pod -n njm<br>NAME                READY   STATUS    RESTARTS   AGE<br>pod-liveness-exec   1/1     Running   1          63s<br></code></pre></div></td></tr></table></figure>

<p>查看详情，提示探测失败，容器将被重启</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112141634425.png" srcset="/img/loading.gif" lazyload alt="image-20211214163426890"></p>
</li>
<li><p><strong>TCPSocket</strong>  pod-liveness-tcpsocket.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-liveness-tcpsocket</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">ports:</span> <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-port</span><br>      <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">livenessProbe:</span><br>      <span class="hljs-attr">tcpSocket:</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span> <span class="hljs-comment"># 尝试访问8080端口</span><br></code></pre></div></td></tr></table></figure>

<p>同样的创建、查看</p>
<p>nginx的端口为80，所以会失败</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112141640339.png" srcset="/img/loading.gif" lazyload alt="image-20211214164003174"></p>
</li>
<li><p><strong>HTTPGet</strong>   pod-liveness-httpget.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-liveness-httpget</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>    <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-port</span><br>      <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">livenessProbe:</span><br>      <span class="hljs-attr">httpGet:</span>  <span class="hljs-comment"># 其实就是访问http://127.0.0.1:80/hello  </span><br>        <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span> <span class="hljs-comment">#支持的协议，http或者https</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">80</span> <span class="hljs-comment">#端口号</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/hello</span> <span class="hljs-comment">#URI地址</span><br></code></pre></div></td></tr></table></figure>

<p>出现404错误，将会重启</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112141649755.png" srcset="/img/loading.gif" lazyload alt="image-20211214164926386"></p>
</li>
</ol>
<h3 id="重启策略"><a href="#重启策略" class="headerlink" title="重启策略"></a>重启策略</h3><p>探测中如果容器出了问题会重启，而重启是由重启策略决定的，有三种：</p>
<ol>
<li>Always（默认）：容器失效时，自动重启该容器</li>
<li>OnFailure： 容器终止运行且退出码不为0时重启</li>
<li>Never： 不论状态为何，都不重启该容器</li>
</ol>
<p>重启策略适用于pod对象中的所有容器，首次需要重启的容器，将在其需要时立即进行重启，随后再次需要重启的操作将由kubelet延迟一段时间后进行，且反复的重启操作的延迟时长以此为10s、20s、40s、80s、160s和300s（最大）</p>
<p>pod-restartpolicy.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-restartpolicy</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>    <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-port</span><br>      <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">livenessProbe:</span><br>      <span class="hljs-attr">httpGet:</span><br>        <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/hello</span><br>  <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Never</span> <span class="hljs-comment"># 设置的是pod的重启策略，所以和containers同一级别，设置重启策略为Never                 </span><br></code></pre></div></td></tr></table></figure>

<p>探测失败后停止容器</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112141701405.png" srcset="/img/loading.gif" lazyload alt="image-20211214170101271"></p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112141701618.png" srcset="/img/loading.gif" lazyload alt="image-20211214170137699"></p>
<h2 id="4-调度"><a href="#4-调度" class="headerlink" title="4.调度"></a>4.调度</h2><p>Pod在哪个node节点上运行，是由scheduler组件决定的，这个过程不受人工控制。如果我们想控制某些Pod到达某些节点上，就需要改变调度规则，k8s提供了4种调度方式</p>
<ol>
<li>自动调度：顾名思义，自动</li>
<li>定向调度：NodeName、NodeSelector</li>
<li>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity</li>
<li>污点（容忍）调度：Taints、Toleration</li>
</ol>
<h3 id="定向调度"><a href="#定向调度" class="headerlink" title="定向调度"></a>定向调度</h3><p>通过在pod上声明nodeName或nodeSelector，以此将Pod调度到期望的node节点上</p>
<h4 id="NodeName"><a href="#NodeName" class="headerlink" title="NodeName"></a><strong>NodeName</strong></h4><p>NodeName强制将Pod调度到指定的Name的Node节点上（即使NodeName不存在）,跳过了scheduler</p>
<p>创建一个pod-nodename.yaml文件</p>
<blockquote>
<p>nodeName是pod的属性，和containers同级</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-nodename</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>  <span class="hljs-attr">nodeName:</span> <span class="hljs-string">node1</span> <span class="hljs-comment"># 指定调度到node1节点上</span><br></code></pre></div></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">创建</span><br>[root@k8s-master dispatch-test]# kubectl create -f pod-nodename.yaml <br>pod/pod-nodename created<br><br><span class="hljs-meta">#</span><span class="bash">查看，由于不存在node3节点，所以pod无法正常运行</span><br>[root@k8s-master dispatch-test]# kubectl get pod -n njm -o wide<br>NAME           READY   STATUS    RESTARTS   AGE   IP       NODE    NOMINATED NODE   READINESS GATES<br>pod-nodename   0/1     Pending   0          45s   &lt;none&gt;   node1   &lt;none&gt;           &lt;none&gt;<br><br></code></pre></div></td></tr></table></figure>

<h4 id="NodeSelector"><a href="#NodeSelector" class="headerlink" title="NodeSelector"></a><strong>NodeSelector</strong></h4><p>NodeSelector用于将pod调度到添加了指定标签的node节点上。它是通过kubernetes的label-selector机制实现的，也就是说，在pod创建之前，会由scheduler使用MatchNodeSelector调度策略进行label匹配，找出目标node，然后将pod调度到目标节点，该匹配规则是强制约束</p>
<p>需要先给node节点添加标签</p>
<p>创建一个pod-nodeselector.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-nodeselector</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>  <span class="hljs-attr">nodeSelector:</span> <br>    <span class="hljs-attr">nodeenv:</span> <span class="hljs-string">pro</span> <span class="hljs-comment"># 指定调度到具有nodeenv=pro标签的节点上</span><br></code></pre></div></td></tr></table></figure>

<p>创建并运行，提示node selector匹配失败的提示</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112151353871.png" srcset="/img/loading.gif" lazyload alt="image-20211215135344439"></p>
<h3 id="亲和性调度"><a href="#亲和性调度" class="headerlink" title="亲和性调度"></a>亲和性调度</h3><p>它在NodeSelector的基础之上的进行了扩展，可以通过配置的形式，实现优先选择满足条件的Node进行调度，如果没有<strong>，也可以调度到不满足条件的节点</strong>上，使调度更加灵活</p>
<p><strong>Affinity</strong>主要分为三类：</p>
<ol>
<li><strong>nodeAffinity</strong>(node亲和性）: 以node为目标，解决pod<strong>可以调度到哪些node</strong>的问题</li>
<li><strong>podAffinity</strong>(pod亲和性) : 以pod为目标，解决pod可<strong>以和哪些已存在的pod部署在同一个</strong>拓扑域中的问题</li>
<li><strong>podAntiAffinity</strong>(pod反亲和性) : 以pod为目标，解决pod<strong>不能和哪些已存在pod部署在同一个</strong>拓扑域中的问题</li>
</ol>
<blockquote>
<p>关于亲和性(反亲和性)使用场景的说明：</p>
<p><strong>亲和性</strong>：如果两个应用频繁交互，那就有必要利用亲和性让两个应用的尽可能的靠近，这样可以减少因网络通信而带来的性能损耗</p>
<p><strong>反亲和性</strong>：当应用的采用多副本部署时，有必要采用反亲和性让各个应用实例打散分布在各个node上，这样可以提高服务的高可用</p>
</blockquote>
<hr>
<h4 id="NodeAffinity"><a href="#NodeAffinity" class="headerlink" title="NodeAffinity"></a><strong>NodeAffinity</strong></h4><p>NodeAffinity主要实现以Node为参照，实现让新创建的Pod在指定的Node中</p>
<p><code>NodeAffinity</code>的可配置项：</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">pod.spec.affinity.nodeAffinity<br>  requiredDuringSchedulingIgnoredDuringExecution  #Node节点必须满足指定的所有规则才可以，相当于硬限制<br>    nodeSelectorTerms  #节点选择列表<br>      matchFields   #按节点字段列出的节点选择器要求列表<br>      matchExpressions   #按节点标签列出的节点选择器要求列表(推荐)<br>        key    #键<br>        values #值<br>        operat or #关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt<br>        <br>  preferredDuringSchedulingIgnoredDuringExecution #优先调度到满足指定的规则的Node，相当于软限制 (倾向)<br>    preference   #一个节点选择器项，与相应的权重相关联<br>      matchFields   #按节点字段列出的节点选择器要求列表<br>      matchExpressions   #按节点标签列出的节点选择器要求列表(推荐)<br>        key    #键<br>        values #值<br>        operator #关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt<br>	weight #倾向权重，在范围1-100<br></code></pre></div></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">关系符的使用说明:<br>- matchExpressions:<br>  - key: nodeenv              # 匹配存在标签的key为nodeenv的节点<br>    operator: Exists<br>  - key: nodeenv              # 匹配标签的key为nodeenv,且value是&quot;xxx&quot;或&quot;yyy&quot;的节点<br>    operator: In<br>    values: [&quot;xxx&quot;,&quot;yyy&quot;]<br>  - key: nodeenv              # 匹配标签的key为nodeenv,且value大于&quot;xxx&quot;的节点<br>    operator: Gt<br>    values: &quot;xxx&quot;<br></code></pre></div></td></tr></table></figure>

<hr>
<p>演示<code>preferredDuringSchedulingIgnoredDuringExecution</code> </p>
<p>创建pod-nodeaffinity-preferred.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-nodeaffinity-preferred</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>  <span class="hljs-attr">affinity:</span>  <span class="hljs-comment">#亲和性设置</span><br>    <span class="hljs-attr">nodeAffinity:</span> <span class="hljs-comment">#设置node亲和性</span><br>      <span class="hljs-attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="hljs-comment"># 软限制</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">weight:</span> <span class="hljs-number">1</span><br>        <span class="hljs-attr">preference:</span><br>          <span class="hljs-attr">matchExpressions:</span> <span class="hljs-comment"># 匹配nodeenv的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签(当前环境没有)</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">nodeenv</span><br>            <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>            <span class="hljs-attr">values:</span> [<span class="hljs-string">&quot;xxx&quot;</span>,<span class="hljs-string">&quot;yyy&quot;</span>]<br></code></pre></div></td></tr></table></figure>

<p>NodeAffinity规则设置的注意事项：</p>
<div class="hljs code-wrapper"><pre><code>1. 如果同时定义了nodeSelector和nodeAffinity，那么必须两个条件都得到满足，Pod才能运行在指定的Node上
2. 如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可
3. 如果一个nodeSelectorTerms中有多个matchExpressions ，则一个节点必须满足所有的才能匹配成功
4. 如果一个pod所在的Node在Pod运行期间其标签发生了改变，不再符合该Pod的节点亲和性需求，则系统将忽略此变化
</code></pre></div>
<hr>
<h4 id="PodAffinity"><a href="#PodAffinity" class="headerlink" title="PodAffinity"></a><strong>PodAffinity</strong></h4><p>PodAffinity主要实现以运行的Pod为参照，实现让新创建的Pod跟参照pod在一个区域的功能</p>
<p><code>PodAffinity</code>的可配置项：</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">pod.spec.affinity.podAffinity<br>  requiredDuringSchedulingIgnoredDuringExecution  #硬限制<br>    namespaces       #指定参照pod的namespace<br>    topologyKey      #指定调度作用域<br>    labelSelector    #标签选择器<br>      matchExpressions  #按节点标签列出的节点选择器要求列表(推荐)<br>        key    #键<br>        values #值<br>        operator #关系符 支持In, NotIn, Exists, DoesNotExist.<br>      matchLabels    #指多个matchExpressions映射的内容<br>  preferredDuringSchedulingIgnoredDuringExecution #软限制<br>    podAffinityTerm  #选项<br>      namespaces      <br>      topologyKey<br>      labelSelector<br>        matchExpressions  <br>          key    #键<br>          values #值<br>          operator<br>        matchLabels <br>    weight #倾向权重，在范围1-100<br></code></pre></div></td></tr></table></figure>

<p>topologyKey用于指定调度时作用域,例如:<br>    如果指定为kubernetes.io/hostname，那就是以Node节点为区分范围<br>    如果指定为beta.kubernetes.io/os,则以Node节点的操作系统类型来区分</p>
<p>演示<code>requiredDuringSchedulingIgnoredDuringExecution</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-podaffinity-required</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>  <span class="hljs-attr">affinity:</span>  <span class="hljs-comment">#亲和性设置</span><br>    <span class="hljs-attr">podAffinity:</span> <span class="hljs-comment">#设置pod亲和性</span><br>      <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="hljs-comment"># 硬限制</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">labelSelector:</span><br>          <span class="hljs-attr">matchExpressions:</span> <span class="hljs-comment"># 匹配podenv的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">podenv</span><br>            <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>            <span class="hljs-attr">values:</span> [<span class="hljs-string">&quot;xxx&quot;</span>,<span class="hljs-string">&quot;yyy&quot;</span>]<br>        <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">kubernetes.io/hostname</span><br></code></pre></div></td></tr></table></figure>

<p>上面配置表达的意思是：新Pod必须要与拥有标签nodeenv=xxx或者nodeenv=yyy的pod在同一Node上</p>
<hr>
<h4 id="PodAntiAffinity"><a href="#PodAntiAffinity" class="headerlink" title="PodAntiAffinity"></a><strong>PodAntiAffinity</strong></h4><p>PodAntiAffinity主要实现以运行的Pod为参照，让新创建的Pod跟参照pod<strong>不在一个区域中</strong></p>
<p>配置方式和选项跟PodAffinty是一样的</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-podantiaffinity-required</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>  <span class="hljs-attr">affinity:</span>  <span class="hljs-comment">#亲和性设置</span><br>    <span class="hljs-attr">podAntiAffinity:</span> <span class="hljs-comment">#设置pod亲和性</span><br>      <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="hljs-comment"># 硬限制</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">labelSelector:</span><br>          <span class="hljs-attr">matchExpressions:</span> <span class="hljs-comment"># 匹配podenv的值在[&quot;pro&quot;]中的标签</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">podenv</span><br>            <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>            <span class="hljs-attr">values:</span> [<span class="hljs-string">&quot;pro&quot;</span>]<br>        <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">kubernetes.io/hostname</span><br></code></pre></div></td></tr></table></figure>

<h3 id="污点和容忍"><a href="#污点和容忍" class="headerlink" title="污点和容忍"></a>污点和容忍</h3><h4 id="污点（Taints）"><a href="#污点（Taints）" class="headerlink" title="污点（Taints）"></a>污点（Taints）</h4><p>前面的调度方式都是站在Pod的角度上，通过Pod，决定<strong>Pod要调度到哪一个Node</strong>上，我们也可以站在Node的角度上，通过在Node上添加<strong>污点</strong>属性，<strong>来决定Node是否允许Pod调度过来</strong></p>
<p>Node被设置上污点之后就和Pod之间存在了一种相斥的关系，进而拒绝Pod调度进来，甚至可以将已经存在的Pod驱逐出去</p>
<p>污点的格式为：<code>key=value:effect</code>, key和value是污点的标签，effect描述污点的作用，有三个选项：</p>
<ul>
<li><strong>PreferNoSchedule（委婉拒绝，除非没办法）</strong>：将<strong>尽量避免</strong>把Pod调度到具有该污点的Node上，除非没有其他节点可调度</li>
<li><strong>NoSchedule（拒绝新的pod）</strong>：将<strong>不会</strong>把Pod调度到具有该污点的Node上，但不会影响当前Node上已存在的Pod</li>
<li><strong>NoExecute（拒绝新的pod和在这的pod）</strong>：将<strong>不会</strong>把Pod调度到具有该污点的Node上，同时也会将Node上已存在的Pod<strong>驱离</strong></li>
</ul>
<p>使用kubectl设置和去除污点的命令示例如下：</p>
<p> <code>kubectl taint nodes 节点名 污点</code></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 设置污点</span><br>kubectl taint nodes node1 key=value:effect<br><span class="hljs-meta">#</span><span class="bash"> 去除某个污点</span><br>kubectl taint nodes node1 key:effect-<br><span class="hljs-meta">#</span><span class="bash"> 去除所有污点</span><br>kubectl taint nodes node1 key-<br><br><span class="hljs-meta">#</span><span class="bash"> 为node1设置污点(PreferNoSchedule)</span><br>[root@k8s-master01 ~]# kubectl taint nodes node1 tag=taint:PreferNoSchedule<br></code></pre></div></td></tr></table></figure>

<h4 id="容忍（Toleration）"><a href="#容忍（Toleration）" class="headerlink" title="容忍（Toleration）"></a>容忍（Toleration）</h4><p>上面介绍了污点的作用，我们可以在node上添加污点用于拒绝pod调度上来，但是如果就是想将一个pod调度到一个有污点的node上去，这时候应该怎么做呢？这就要使用到<strong>容忍</strong></p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112151732124.png" srcset="/img/loading.gif" lazyload alt="image-20211215173159089"></p>
<blockquote>
<p>污点就是拒绝，容忍就是忽略，Node通过污点拒绝pod调度上去，Pod通过容忍忽略拒绝</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-toleration</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>  <span class="hljs-attr">tolerations:</span>      <span class="hljs-comment"># 添加容忍</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;tag&quot;</span>        <span class="hljs-comment"># 要容忍的污点的key</span><br>    <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Equal&quot;</span> <span class="hljs-comment"># 操作符</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;taint&quot;</span>    <span class="hljs-comment"># 容忍的污点的value</span><br>    <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoExecute&quot;</span>   <span class="hljs-comment"># 添加容忍的规则，这里必须和标记的污点规则相同</span><br></code></pre></div></td></tr></table></figure>

<p>容忍的详细配置:</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@k8s-master01 ~]# kubectl explain pod.spec.tolerations<br>......<br>FIELDS:<br>   key       # 对应着要容忍的污点的键，空意味着匹配所有的键<br>   value     # 对应着要容忍的污点的值<br>   operator  # key-value的运算符，支持Equal和Exists（默认）<br>   effect    # 对应污点的effect，空意味着匹配所有影响<br>   tolerationSeconds   # 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间<br></code></pre></div></td></tr></table></figure>

<h1 id="六、Pod控制器"><a href="#六、Pod控制器" class="headerlink" title="六、Pod控制器"></a>六、Pod控制器</h1><p>按照pod的创建方式可以分为两类：</p>
<ul>
<li>自主式pod：<strong>直接创建出来的pod</strong>，这种pod删除后就没有了，也不会重建</li>
<li>控制器创建的pod：<strong>通过控制器创建的pod</strong>，这种pod删除了之后还会自动重建</li>
</ul>
<p>Pod控制器是管理pod的中间层，通过pod控制器，可以规定需要多少个什么样的pod，如果pod在运行出现故障，pod控制器会基于指定策略重启pod</p>
<p>pod控制器有很多种，每种都有自己的适合场景：</p>
<ul>
<li>ReplicationController：已经被废弃，由ReplicaSet替代</li>
<li>ReplicaSet：保证副本数量一直维持在期望值，并支持pod数量扩缩容，镜像版本升级</li>
<li><strong>Deployment</strong>：通过控制ReplicaSet来控制Pod，并支持滚动升级、回退版本</li>
<li>Horizontal Pod Autoscaler：可以根据集群负载自动水平调整Pod的数量，实现削峰填谷</li>
<li>DaemonSet：在集群中的指定Node上运行且仅运行一个副本，一般用于守护进程类的任务</li>
<li>Job：它创建出来的pod只要完成任务就立即退出，用于执行一次性任务</li>
<li>Cronjob：它创建的Pod和周期性的执行，用于执行周期性任务</li>
<li>StatefulSet：管理有状态应用</li>
</ul>
<h2 id="1-ReplicaSet-rs"><a href="#1-ReplicaSet-rs" class="headerlink" title="1.ReplicaSet(rs)"></a>1.ReplicaSet(rs)</h2><p>简称RS，主要<strong>保证一定数量的pod能够正常运行</strong>，它会持续监听这些pod的运行状态，一旦pod发生故障就会重启或重建，同时还支持对pod数量的扩缩容和版本镜像的升级</p>
<p>yaml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span> <span class="hljs-comment"># 版本号</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ReplicaSet</span> <span class="hljs-comment"># 类型       </span><br><span class="hljs-attr">metadata:</span> <span class="hljs-comment"># 元数据</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-comment"># rs名称 </span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-comment"># 所属命名空间 </span><br>  <span class="hljs-attr">labels:</span> <span class="hljs-comment">#标签</span><br>    <span class="hljs-attr">controller:</span> <span class="hljs-string">rs</span><br><span class="hljs-attr">spec:</span> <span class="hljs-comment"># 详情描述</span><br><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 副本数量</span><br>  <span class="hljs-attr">selector:</span> <span class="hljs-comment"># 选择器，通过它指定该控制器管理哪些pod</span><br>    <span class="hljs-attr">matchLabels:</span>      <span class="hljs-comment"># Labels匹配规则</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-pod</span>  <span class="hljs-comment"># 即管理标签为app:nginx-pod的pod</span><br>    <span class="hljs-attr">matchExpressions:</span> <span class="hljs-comment"># Expressions匹配规则</span><br>      <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">key:</span> <span class="hljs-string">app</span>, <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>, <span class="hljs-attr">values:</span> [<span class="hljs-string">nginx-pod</span>]&#125;<br>      <br>  <span class="hljs-attr">template:</span> <span class="hljs-comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-pod</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br></code></pre></div></td></tr></table></figure>

<p><code>spec</code>下面几个选项：</p>
<ul>
<li><p>replicas：指定副本数量，其实就是当前rs创建出来的pod的数量，默认为1</p>
</li>
<li><p>selector：选择器，它的作用是建立pod控制器和pod之间的关联关系，采用的Label Selector机制</p>
<p>在pod模板上定义label，在控制器上定义选择器，就可以表明当前控制器能管理哪些pod了</p>
</li>
<li><p>template：模板，就是当前控制器创建pod所使用的模板板，里面其实就是pod的定义</p>
</li>
</ul>
<hr>
<p><strong>创建ReplicaSet</strong></p>
<p>创建replicaset.yaml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ReplicaSet</span>   <br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pc-replicaset</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span> <br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-pod</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-pod</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br></code></pre></div></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">创建rs</span><br><span class="hljs-meta">[root@k8s-master]#</span><span class="bash"> kubectl create -f replicaset.yaml</span> <br>replicaset.apps/pc-replicaset created<br><br><span class="hljs-meta">#</span><span class="bash">查看rs</span><br><span class="hljs-meta">#</span><span class="bash"> desire:期望副本数量</span>  <br><span class="hljs-meta">#</span><span class="bash"> current:当前副本数量</span>  <br><span class="hljs-meta">#</span><span class="bash"> ready:已经准备好提供服务的副本数量</span><br><span class="hljs-meta">[root@k8s-mastert]#</span><span class="bash"> kubectl get rs -n njm -o wide</span><br>NAME            DESIRED   CURRENT   READY   AGE    CONTAINERS   IMAGES         SELECTOR<br>pc-replicaset   3         3         3       2m8s   nginx        nginx:1.17.1   app=nginx-pod<br><br><span class="hljs-meta">#</span><span class="bash">查看pod</span><br><span class="hljs-meta">#</span><span class="bash">这里发现控制器创建出来的pod的名称是在控制器名称后面拼接了-xxxxx随机码</span><br><span class="hljs-meta">[root@k8s-master]#</span><span class="bash"> kubectl get pod -n njm</span> <br>NAME                  READY   STATUS    RESTARTS   AGE<br>pc-replicaset-84rcb   1/1     Running   0          3m35s<br>pc-replicaset-k6rxm   1/1     Running   0          3m35s<br>pc-replicaset-kmn5m   1/1     Running   0          3m35s<br><br></code></pre></div></td></tr></table></figure>

<hr>
<p><strong>扩缩容</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 编辑rs的副本数量，修改spec:replicas: 6即可</span><br>[root@k8s-master01 ~]# kubectl edit rs pc-replicaset -n njm<br>replicaset.apps/pc-replicaset edited<br><br><span class="hljs-meta">#</span><span class="bash"> 当然也可以直接使用命令实现</span><br><span class="hljs-meta">#</span><span class="bash"> 使用scale命令实现扩缩容， 后面--replicas=n直接指定目标数量即可</span><br>[root@k8s-master01 ~]# kubectl scale rs pc-replicaset --replicas=2 -n njm<br>replicaset.apps/pc-replicaset scaled<br></code></pre></div></td></tr></table></figure>

<p><strong>镜像更新</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 编辑rs的容器镜像 - image: nginx:1.17.2</span><br>[root@k8s-master01 ~]# kubectl edit rs pc-replicaset -n njm<br>replicaset.apps/pc-replicaset edited<br><br><span class="hljs-meta">#</span><span class="bash"> 使用命令kubectl <span class="hljs-built_in">set</span> image rs rs名称 容器=镜像版本 -n namespace</span><br>[root@k8s-master01 ~]# kubectl set image rs pc-replicaset nginx=nginx:1.17.2  -n njm<br>replicaset.apps/pc-replicaset image updated<br></code></pre></div></td></tr></table></figure>

<p><strong>删除ReplicaSet</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 使用kubectl delete命令会删除此RS以及它管理的Pod</span><br><span class="hljs-meta">#</span><span class="bash"> 在kubernetes删除RS前，会将RS的replicasclear调整为0，等待所有的Pod被删除后，在执行RS对象的删除</span><br>[root@k8s-master01 ~]# kubectl delete rs pc-replicaset -n dev<br>replicaset.apps &quot;pc-replicaset&quot; deleted<br><br><span class="hljs-meta">#</span><span class="bash"> 也可以使用yaml直接删除</span><br>[root@k8s-master01 ~]# kubectl delete -f pc-replicaset.yaml<br>replicaset.apps &quot;pc-replicaset&quot; deleted<br><br><span class="hljs-meta">#</span><span class="bash"> 如果只删除RS对象（保留Pod），可以使用添加--cascade=<span class="hljs-literal">false</span>（级联删除=<span class="hljs-literal">false</span>）</span><br>[root@k8s-master01 ~]# kubectl delete rs pc-replicaset -n dev --cascade=false<br>replicaset.apps &quot;pc-replicaset&quot; deleted<br>[root@k8s-master01 ~]# kubectl get pods -n dev<br>NAME                  READY   STATUS    RESTARTS   AGE<br>pc-replicaset-cl82j   1/1     Running   0          75s<br>pc-replicaset-dslhb   1/1     Running   0          75s<br></code></pre></div></td></tr></table></figure>

<h2 id="2-Deployment（deploy）"><a href="#2-Deployment（deploy）" class="headerlink" title="2.Deployment（deploy）"></a>2.Deployment（deploy）</h2><p><strong>Deployment</strong>并不直接管理pod，而是通过管理<strong>ReplicaSet</strong>来间接管理Pod，即：<strong>Deployment</strong>管理<strong>ReplicaSet</strong>，<strong>ReplicaSet</strong>管理<strong>Pod</strong>，所以<strong>Deployment</strong>比<strong>ReplicaSet</strong>功能更加强大</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112161438627.png" srcset="/img/loading.gif" lazyload alt="image-20211216143827793"></p>
<p>Deployment主要功能：</p>
<ul>
<li>支持ReplicaSet的所有功能</li>
<li>支持发布的停止、继续</li>
<li>支持滚动升级和回滚版本</li>
</ul>
<p>yaml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span> <span class="hljs-comment"># 版本号</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span> <span class="hljs-comment"># 类型       </span><br><span class="hljs-attr">metadata:</span> <span class="hljs-comment"># 元数据</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-comment"># 名称 </span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-comment"># 所属命名空间 </span><br>  <span class="hljs-attr">labels:</span> <span class="hljs-comment">#标签</span><br>    <span class="hljs-attr">controller:</span> <span class="hljs-string">deploy</span><br>    <br><span class="hljs-attr">spec:</span> <span class="hljs-comment"># 详情描述</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 副本数量</span><br>  <span class="hljs-attr">revisionHistoryLimit:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 保留历史版本个数</span><br>  <span class="hljs-attr">paused:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 暂停部署，默认是false</span><br>  <span class="hljs-attr">progressDeadlineSeconds:</span> <span class="hljs-number">600</span> <span class="hljs-comment"># 部署超时时间（s），默认是600</span><br>  <span class="hljs-attr">strategy:</span> <span class="hljs-comment"># 策略</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span> <span class="hljs-comment"># 滚动更新策略</span><br>    <span class="hljs-attr">rollingUpdate:</span> <span class="hljs-comment"># 滚动更新</span><br>      <span class="hljs-attr">maxSurge:</span> <span class="hljs-number">30</span><span class="hljs-string">%</span> <span class="hljs-comment"># 最大额外可以存在的副本数，可以为百分比，也可以为整数</span><br>      <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">30</span><span class="hljs-string">%</span> <span class="hljs-comment"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span><br>  <span class="hljs-attr">selector:</span> <span class="hljs-comment"># 选择器，通过它指定该控制器管理哪些pod</span><br>    <span class="hljs-attr">matchLabels:</span>      <span class="hljs-comment"># Labels匹配规则</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-pod</span><br>    <span class="hljs-attr">matchExpressions:</span> <span class="hljs-comment"># Expressions匹配规则</span><br>      <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">key:</span> <span class="hljs-string">app</span>, <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>, <span class="hljs-attr">values:</span> [<span class="hljs-string">nginx-pod</span>]&#125;<br>      <br>  <span class="hljs-attr">template:</span> <span class="hljs-comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-pod</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br></code></pre></div></td></tr></table></figure>

<hr>
<h3 id="创建deployment"><a href="#创建deployment" class="headerlink" title="创建deployment"></a>创建deployment</h3><p>创建pc-deployment.yaml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>      <br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pc-deployment</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span> <br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-pod</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-pod</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br></code></pre></div></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 创建deployment</span><br><span class="hljs-meta">[root@k8s-master]#</span><span class="bash"> kubectl create -f pc-deployment.yaml</span> <br>deployment.apps/pc-deployment created<br><br><span class="hljs-meta">#</span><span class="bash"> 查看deployment</span><br><span class="hljs-meta">#</span><span class="bash"> UP-TO-DATE 最新版本的pod的数量</span><br><span class="hljs-meta">#</span><span class="bash"> AVAILABLE  当前可用的pod的数量</span><br><span class="hljs-meta">[root@k8s-master]#</span><span class="bash"> kubectl get deploy -n njm</span><br>NAME            READY   UP-TO-DATE   AVAILABLE   AGE<br>pc-deployment   3/3     3            3           101s<br><br><span class="hljs-meta">#</span><span class="bash"> 查看pod</span><br><span class="hljs-meta">[root@k8s-master]#</span><span class="bash"> kubectl get pod -n njm</span><br>NAME                             READY   STATUS    RESTARTS   AGE<br>pc-deployment-5d9c9b97bb-fs2cp   1/1     Running   0          3m<br>pc-deployment-5d9c9b97bb-kch8l   1/1     Running   0          3m<br>pc-deployment-5d9c9b97bb-rjns8   1/1     Running   0          3m<br></code></pre></div></td></tr></table></figure>

<h3 id="扩缩容"><a href="#扩缩容" class="headerlink" title="扩缩容"></a>扩缩容</h3><p>和rs差不多</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 第一种 变更副本数量为5个</span><br>[root@k8s-master01 ~]# kubectl scale deploy pc-deployment --replicas=5  -n njm<br>deployment.apps/pc-deployment scaled<br><br><span class="hljs-meta">#</span><span class="bash"> 第二种 编辑deployment的副本数量，修改spec:replicas: 4</span><br>[root@k8s-master01 ~]# kubectl edit deploy pc-deployment -n dev<br>deployment.apps/pc-deployment edited<br></code></pre></div></td></tr></table></figure>

<h3 id="镜像更新"><a href="#镜像更新" class="headerlink" title="镜像更新"></a>镜像更新</h3><p>deployment支持两种更新策略:</p>
<ul>
<li>重建更新：一次性删掉所有旧版本pod，立即重建同等数量的新版本pod</li>
<li>滚动更新（默认）：先删一部分旧版本pod，再重建一部分新版本pod，以此类推</li>
</ul>
<p>可以通过<code>strategy</code>指定策略类型</p>
<figure class="highlight markdown"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs markdown">strategy: 指定新的Pod替换旧的Pod的策略， 支持两个属性：<br>  type: 指定策略类型，支持两种策略<br><span class="hljs-code">    Recreate: 重建更新</span><br><span class="hljs-code">    RollingUpdate: 滚动更新中</span><br><span class="hljs-code">  rollingUpdate: 当type为RollingUpdate时生效，用于为RollingUpdate设置参数，支持两个属性：</span><br><span class="hljs-code">    maxUnavailable: 用来指定在升级过程中不可用Pod的最大数量，默认为25%。</span><br><span class="hljs-code">    maxSurge: 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%。</span><br></code></pre></div></td></tr></table></figure>

<p><strong>重建更新</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">strategy:</span>	<span class="hljs-comment">#策略</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">Recreate</span>	<span class="hljs-comment">#重建更新</span><br></code></pre></div></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 变更镜像</span><br><span class="hljs-meta">[root@k8s-master]#</span><span class="bash"> kubectl <span class="hljs-built_in">set</span> image deployment pc-deployment nginx=nginx -n njm</span><br>deployment.apps/pc-deployment image updated<br><br><span class="hljs-meta">#</span><span class="bash">查看 正在停止</span><br><span class="hljs-meta">[root@k8s-master]#</span><span class="bash"> kubectl get pod -n njm</span><br>NAME                             READY   STATUS   	  RESTARTS   AGE<br>pc-deployment-7cbfc8fc88-2cpnp   1/1     Terminating   0          63s<br>pc-deployment-7cbfc8fc88-gx4lq   1/1     Terminating   0          63s<br>pc-deployment-7cbfc8fc88-v2b9t   1/1     Terminating   0          63s<br><span class="hljs-meta">#</span><span class="bash">查看 正在创建</span><br><span class="hljs-meta">[root@k8s-master]#</span><span class="bash"> kubectl get pod -n njm</span><br>NAME                             READY   STATUS              RESTARTS   AGE              <br>pc-deployment-7cbfc8fc88-2cpnp   0/1     ContainerCreating   0          2s <br>pc-deployment-7cbfc8fc88-gx4lq   0/1     ContainerCreating   0          2s  <br>pc-deployment-7cbfc8fc88-v2b9t   0/1     ContainerCreating   0          2s <br><span class="hljs-meta">#</span><span class="bash">查看 正在运行</span><br><span class="hljs-meta">[root@k8s-master]#</span><span class="bash"> kubectl get pod -n njm</span><br>NAME                             READY   STATUS    RESTARTS   AGE<br>pc-deployment-7cbfc8fc88-2cpnp   1/1     Running   0          63s<br>pc-deployment-7cbfc8fc88-gx4lq   1/1     Running   0          63s<br>pc-deployment-7cbfc8fc88-v2b9t   1/1     Running   0          63s<br><br></code></pre></div></td></tr></table></figure>

<p><strong>滚动更新</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">strategy:</span> <span class="hljs-comment"># 策略</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span> <span class="hljs-comment"># 滚动更新策略</span><br>    <span class="hljs-attr">rollingUpdate:</span><br>      <span class="hljs-attr">maxSurge:</span> <span class="hljs-number">25</span><span class="hljs-string">%</span> <br>      <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">25</span><span class="hljs-string">%</span><br></code></pre></div></td></tr></table></figure>

<p>其他都一样</p>
<h3 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a>版本回退</h3><p>在滚动更新中<strong>原来的rs依旧存在</strong>，只是pod数量变为了0，而后又新产生了一个rs，pod数量为3<br>这就是deployment能够进行版本回退的原因</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">[root@k8s-master]#</span><span class="bash"> kubectl get rs -n njm</span><br>NAME                       DESIRED   CURRENT   READY   AGE<br>pc-deployment-5d9c9b97bb   0         0         0       85s<br>pc-deployment-7cbfc8fc88   3         3         3       14s<br></code></pre></div></td></tr></table></figure>

<p>deployment支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能</p>
<p>kubectl rollout： 版本升级相关功能，支持下面的选项：</p>
<ul>
<li>status    显示当前升级状态</li>
<li>history   显示 升级历史记录</li>
<li>pause    暂停版本升级过程</li>
<li>resume   继续已经暂停的版本升级过程</li>
<li>restart    重启版本升级过程</li>
<li>undo 回滚到上一级版本（可以使用–to-revision回滚到指定版本）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 查看当前升级版本的状态</span><br><span class="hljs-meta">[root@k8s-master]#</span><span class="bash"> kubectl rollout status deploy pc-deployment -n njm</span><br>deployment &quot;pc-deployment&quot; successfully rolled out<br><br><span class="hljs-meta">#</span><span class="bash"> 查看升级历史记录,有两个版本.CHANGE-CAUSE是因为在启动时没有加--record=<span class="hljs-literal">true</span>，所以没有记录</span><br><span class="hljs-meta">[root@k8s-master]#</span><span class="bash"> kubectl rollout <span class="hljs-built_in">history</span> deploy pc-deployment -n njm</span><br>deployment.apps/pc-deployment <br>REVISION  CHANGE-CAUSE<br>1         &lt;none&gt;<br>2         &lt;none&gt;<br></code></pre></div></td></tr></table></figure>

<p><strong>版本回退</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 这里直接使用--to-revision=1回滚到了1版本， 如果省略这个选项，默认回退到上个版本</span><br>[root@k8s-master ]# kubectl rollout undo deployment pc-deployment --to-revision=1 -n njm<br>deployment.apps/pc-deployment rolled back<br><br><span class="hljs-meta">#</span><span class="bash"> 查看rs 发现第一个rs中变成了有3个pod运行</span><br>[root@k8s-master ]# kubectl get rs -n njm<br>NAME                       DESIRED   CURRENT   READY   AGE<br>pc-deployment-5d9c9b97bb   3         3         3       12m<br>pc-deployment-7cbfc8fc88   0         0         0       10m<br></code></pre></div></td></tr></table></figure>

<p>其实deployment之所以可是实现版本的回滚，就是通过记录下历史rs来实现的，一旦想回滚到哪个版本，只需要将当前版本pod数量降为0，然后将回滚版本的pod提升为目标数量就可以了</p>
<h2 id="3-DaemonSet-DS"><a href="#3-DaemonSet-DS" class="headerlink" title="3.DaemonSet(DS)"></a>3.DaemonSet(DS)</h2><p>DaemonSet控制器可以保证在集群中的每一台（或指定）节点上都运行一个副本。一般适用于日志收集、节点监控等场景。</p>
<p>也就是说，如果一个Pod提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类Pod就适合使用DaemonSet类型的控制器创建。</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112171645439.png" srcset="/img/loading.gif" lazyload alt="image-20211217164517412"></p>
<p>DaemonSet控制器的特点：</p>
<ul>
<li>每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上</li>
<li>当节点从集群中移除时，Pod 也就被垃圾回收了</li>
</ul>
<p>yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span> <span class="hljs-comment"># 版本号</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span> <span class="hljs-comment"># 类型       </span><br><span class="hljs-attr">metadata:</span> <span class="hljs-comment"># 元数据</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-comment"># rs名称 </span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-comment"># 所属命名空间 </span><br>  <span class="hljs-attr">labels:</span> <span class="hljs-comment">#标签</span><br>    <span class="hljs-attr">controller:</span> <span class="hljs-string">daemonset</span><br>    <br><span class="hljs-attr">spec:</span> <span class="hljs-comment"># 详情描述</span><br>  <span class="hljs-attr">revisionHistoryLimit:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 保留历史版本</span><br>  <span class="hljs-attr">updateStrategy:</span> <span class="hljs-comment"># 更新策略</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span> <span class="hljs-comment"># 滚动更新策略</span><br>    <span class="hljs-attr">rollingUpdate:</span> <span class="hljs-comment"># 滚动更新</span><br>      <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span><br>  <span class="hljs-attr">selector:</span> <span class="hljs-comment"># 选择器，通过它指定该控制器管理哪些pod</span><br>    <span class="hljs-attr">matchLabels:</span>      <span class="hljs-comment"># Labels匹配规则</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-pod</span><br>    <span class="hljs-attr">matchExpressions:</span> <span class="hljs-comment"># Expressions匹配规则</span><br>      <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">key:</span> <span class="hljs-string">app</span>, <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>, <span class="hljs-attr">values:</span> [<span class="hljs-string">nginx-pod</span>]&#125;<br>      <br>  <span class="hljs-attr">template:</span> <span class="hljs-comment"># 模板</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-pod</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.17.1</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br></code></pre></div></td></tr></table></figure>

<h2 id="4-Job"><a href="#4-Job" class="headerlink" title="4.Job"></a>4.Job</h2><p>主要用于负责**批量处理(一次要处理指定数量任务)<strong>短暂的</strong>一次性(每个任务仅运行一次就结束)**任务</p>
<ul>
<li>当Job创建的pod执行成功结束时，Job将记录成功结束的pod数量</li>
<li>当成功结束的pod达到指定的数量时，Job将完成执行</li>
</ul>
<p>yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1</span> <span class="hljs-comment"># 版本号</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Job</span> <span class="hljs-comment"># 类型       </span><br><span class="hljs-attr">metadata:</span> <span class="hljs-comment"># 元数据</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-comment"># rs名称 </span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-comment"># 所属命名空间 </span><br>  <span class="hljs-attr">labels:</span> <span class="hljs-comment">#标签</span><br>    <span class="hljs-attr">controller:</span> <span class="hljs-string">job</span><br>    <br><span class="hljs-attr">spec:</span> <span class="hljs-comment"># 详情描述</span><br>  <span class="hljs-attr">completions:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 指定job需要成功运行Pods的次数。默认值: 1</span><br>  <span class="hljs-attr">parallelism:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 指定job在任一时刻应该并发运行Pods的数量。默认值: 1</span><br>  <span class="hljs-attr">activeDeadlineSeconds:</span> <span class="hljs-number">30</span> <span class="hljs-comment"># 指定job可运行的时间期限，超过时间还未结束，系统将会尝试进行终止</span><br>  <span class="hljs-attr">backoffLimit:</span> <span class="hljs-number">6</span> <span class="hljs-comment"># 指定job失败后进行重试的次数。默认是6</span><br>  <span class="hljs-attr">manualSelector:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 是否可以使用selector选择器选择pod，默认是false</span><br>  <span class="hljs-attr">selector:</span> <span class="hljs-comment"># 选择器，通过它指定该控制器管理哪些pod</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">counter-pod</span><br>    <span class="hljs-attr">matchExpressions:</span><br>      <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">key:</span> <span class="hljs-string">app</span>, <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>, <span class="hljs-attr">values:</span> [<span class="hljs-string">counter-pod</span>]&#125;<br>      <br>  <span class="hljs-attr">template:</span> <span class="hljs-comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">counter-pod</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Never</span> <span class="hljs-comment"># 重启策略只能设置为Never或者OnFailure</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">counter</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.30</span><br>        <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;bin/sh&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done&quot;</span>]<br></code></pre></div></td></tr></table></figure>

<p>restartPolicy重启策略：<br>    如果指定为OnFailure，则job会在pod出现故障时重启容器，而不是创建pod，failed次数不变<br>    如果指定为Never，则job会在pod出现故障时创建新的pod，并且故障pod不会消失，也不会重启，failed次数加1</p>
<hr>
<p>创建job</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Job</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pc-job</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">manualSelector:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">counter-pod</span><br><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">counter-pod</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Never</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">counter</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.30</span><br>        <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;bin/sh&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;</span>]<br></code></pre></div></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">pod在运行完毕任务后，就会变成Completed状态</span><br>[root@k8s-master ]# kubectl get pod -n njm<br>NAME           READY   STATUS    RESTARTS   AGE<br>pc-job-hh9fs   1/1     Running   0          7s<br><br>[root@k8s-master ]# kubectl get pod -n njm<br>NAME           READY   STATUS      RESTARTS   AGE<br>pc-job-hh9fs   0/1     Completed   0          35s<br></code></pre></div></td></tr></table></figure>

<h1 id="七、Service"><a href="#七、Service" class="headerlink" title="七、Service"></a>七、Service</h1><blockquote>
<p>每个Pod都会分配一个单独的Pod IP，但是该IP会随着Pod的重建而变化，且该IP为集群内部的虚拟IP，外部无法访问。因此kubernets设计了Service来解决这个问题</p>
</blockquote>
<p>​    <strong>Service</strong>会对提供同一个服务的多个pod进行聚合，并提供一个统一的入口地址。通过访问Service的入口地址就能访问到后面的pod服务</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112091030050.png" srcset="/img/loading.gif" lazyload alt="image-20211209103014124"></p>
<p>​    Service在很多情况下只是一个概念，真正起作用的其实是kube-proxy服务进程，每个Node节点上都运行着一个kube-proxy服务进程。当创建Service的时候会通过api-server向etcd写入创建的service的信息，而kube-proxy会基于监听的机制发现这种Service的变动，然后<strong>它会将最新的Service信息转换成对应的访问规则</strong></p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112171349232.png" srcset="/img/loading.gif" lazyload alt="image-20211217134945154"></p>
<p>两种不同的service类型</p>
<p>ClusterIP ：Service 通过 Cluster 内部的 IP 对外提供服务，只有 Cluster 内的节点和 Pod 可访问，这是默认的 Service 类型</p>
<p>NodePort ：Service 通过 Cluster 节点的静态端口对外提供服务。Cluster 外部可以通过 <code>&lt;NodeIP&gt;:&lt;NodePort&gt;</code> 访问 Service</p>
<h2 id="1-命令方式"><a href="#1-命令方式" class="headerlink" title="1.命令方式"></a>1.命令方式</h2><p><strong>操作一：创建集群内部可访问的Service</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> Service通过deployment找到要管理的pod</span><br><span class="hljs-meta">#</span><span class="bash"> --name Service的名字</span><br><span class="hljs-meta">#</span><span class="bash"> --<span class="hljs-built_in">type</span> Serive的类型，ClusterIP指集群内部可访问</span><br><span class="hljs-meta">#</span><span class="bash"> --port Service的端口</span><br><span class="hljs-meta">#</span><span class="bash"> --target-port 目标的端口</span><br><span class="hljs-meta">#</span><span class="bash"> -n 命名空间</span><br>[root@master ~]# kubectl expose deploy nginx --name=svc-nginx1 --type=ClusterIP --port=80 --target-port=80 -n dev<br>service/svc-nginx1 exposed<br><br><span class="hljs-meta">#</span><span class="bash"> 查看service，svc是service的缩写</span><br><span class="hljs-meta">#</span><span class="bash"> 这里产生了一个CLUSTER-IP，这就是service的IP，在Service的生命周期中，这个地址是不会变动的</span><br>[root@master ~]# kubectl get svc svc-nginx1 -n dev -o wide<br>NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE     SELECTOR<br>svc-nginx1   ClusterIP   10.109.179.231   &lt;none&gt;        80/TCP    3m51s   run=nginx<br><br><span class="hljs-meta">#</span><span class="bash"> 访问，service会随机寻找一个</span><br>[root@master ~]# curl 10.109.179.231:80<br></code></pre></div></td></tr></table></figure>

<p><strong>操作二：创建集群外部可访问的Service</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 修改类型为NodePort</span><br>[root@master ~]# kubectl expose deploy nginx --name=svc-nginx2 --type=NodePort --port=80 --target-port=80 -n dev<br><br><span class="hljs-meta">#</span><span class="bash"> 查看</span><br><span class="hljs-meta">#</span><span class="bash"> 此时查看，会发现出现了NodePort类型的Service，而且有一对Port（80:31928）</span><br>[root@master ~]# kubectl get svc  svc-nginx2  -n dev -o wide<br>NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE    SELECTOR<br>svc-nginx2    NodePort    10.100.94.0      &lt;none&gt;        80:31928/TCP   9s     run=nginx<br><br><span class="hljs-meta">#</span><span class="bash"> 接下来就可以通过集群外的主机访问 节点IP:31928访问服务了</span><br><span class="hljs-meta">#</span><span class="bash"> 电脑主机上通过浏览器访问下面的地址（master主机的地址）会跳转到service 10.100.94.0:80</span><br>http://192.168.90.100:31928/<br><br><span class="hljs-meta">#</span><span class="bash"> 删除service</span><br>[root@master ~]# kubectl delete svc svc-nginx-2 -n dev <br>service &quot;svc-nginx-1&quot; deleted<br></code></pre></div></td></tr></table></figure>

<hr>
<h2 id="2-配置方式"><a href="#2-配置方式" class="headerlink" title="2.配置方式"></a><strong>2.配置方式</strong></h2><ol>
<li><p>首先创建一个deployment管理pod</p>
<p>创建了三个httpd的pod，端口为80</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br>  <br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">httpd</span><br>      <br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">httpd</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">httpd</span><br>         <span class="hljs-attr">name:</span> <span class="hljs-string">httpd</span><br>         <span class="hljs-attr">ports:</span><br>         <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br></code></pre></div></td></tr></table></figure>

<p>查看，三个pod的ip分别为.3、.4、.5</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@k8s-master service-test]# kubectl get pod -n njm -o wide<br>NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE              <br>httpd-5dcdfd6b9f-mgzgp   1/1     Running   0          36m   172.29.16.3   192.168.70.28 <br>httpd-5dcdfd6b9f-ntr5x   1/1     Running   0          36m   172.29.16.4   192.168.70.28<br>httpd-5dcdfd6b9f-spf6n   1/1     Running   0          36m   172.29.16.5   192.168.70.28   <br></code></pre></div></td></tr></table></figure>

<ol start="2">
<li>创建service</li>
</ol>
<p><code>nodePort</code>：（主机）节点的端口，省略的话随机分配</p>
<p><code>port</code>：service的端口</p>
<p><code>targetPort</code>：目标pod的端口</p>
<p><code>type</code>：service的类型</p>
<p><code>selector</code>：标签选择器，上一步<code>deploy</code>标签为<code>run: httpd</code>，这里对应</p>
<p><code>sessionAffinity</code>：session亲和性，支持ClientIP、None。比如三个pod位于A、B、C三个地区，对于来自A地区的请求要交给A地区的pod</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">httpd-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">njm</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">run:</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-number">10.</span><span class="hljs-string">xx.xx.xx</span> <span class="hljs-comment"># service的ip 可省略</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">sessionAffinity:</span> <span class="hljs-comment">#session亲和性</span><br></code></pre></div></td></tr></table></figure>

<p>查看</p>
<p><code>PORT(S)</code> 为 <code>80:58721 </code>，<code>80</code> 是 service的端口（即port），<code>58721</code> 则是主机（或者节点）上监听的端口。每个节点都会监听此端口并将请求转发给 Service</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@k8s-master service-test]# kubectl get svc -n njm<br>NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE<br>httpd-service   NodePort   10.253.12.26   &lt;none&gt;        80:58721/TCP   23m<br></code></pre></div></td></tr></table></figure>

<p>查看 httpd-svc 与 Pod 的对应关系</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@k8s-master service-test]# kubectl describe service httpd-service -n njm<br>Name:                     httpd-service<br>Namespace:                njm<br>Labels:                   &lt;none&gt;<br>Annotations:              &lt;none&gt;<br>Selector:                 run=httpd<br>Type:                     NodePort<br>IP:                       10.253.12.26<br>Port:                     &lt;unset&gt;  80/TCP<br>TargetPort:               80/TCP<br>NodePort:                 &lt;unset&gt;  58721/TCP<br>Endpoints:                172.29.16.3:80,172.29.16.4:80,172.29.16.5:80<br>Session Affinity:         None<br>External Traffic Policy:  Cluster<br>Events:                   &lt;none&gt;<br></code></pre></div></td></tr></table></figure>

<ol start="3">
<li>访问</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 通过service的ip访问</span><br>[root@k8s-master ~]# curl 10.253.12.26:80<br>&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br><br><span class="hljs-meta">#</span><span class="bash"> 通过主机的ip访问</span><br>[root@k8s-master ~]# curl 192.168.70.28:58721<br>&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br></code></pre></div></td></tr></table></figure>

<h2 id="3-工作原理"><a href="#3-工作原理" class="headerlink" title="3.工作原理"></a>3.工作原理</h2><p>使用<code>iptables-save | grep serviceIP</code>查看规则</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[root@k8s-master ~]# iptables-save | grep 10.253.12.26<br>-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.253.12.26/32 -p tcp -m comment --comment &quot;njm/httpd-service cluster IP&quot; -m tcp --dport 80 -j KUBE-MARK-MASQ<br>-A KUBE-SERVICES -d 10.253.12.26/32 -p tcp -m comment --comment &quot;njm/httpd-service cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-6DSZY5JO37TTEYHN<br></code></pre></div></td></tr></table></figure>

<p>这两条规则的含义是：</p>
<ol>
<li>如果 Cluster 内的 Pod（源地址来自 10.253.0.0/16）要访问 <code>httpd-service</code>，则允许</li>
<li>其他源地址访问 <code>httpd-service</code>，跳转到规则<code>KUBE-SVC-6DSZY5JO37TTEYHN</code></li>
</ol>
<hr>
<p>查看<code>KUBE-SVC-6DSZY5JO37TTEYHN</code>规则</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112231453021.png" srcset="/img/loading.gif" lazyload alt="image-20211223143306492"></p>
<p>这三条规则的含义是：</p>
<ol>
<li>1/3 的概率跳转到规则<code> KUBE-SEP-YZI6E5F46FBZHQJD</code></li>
<li>1/3 的概率（剩下 2/3 的一半）跳转到规则<code> KUBE-SEP-YZI6E5F46FBZHQJD</code></li>
<li>1/3 的概率跳转到规则 <code>KUBE-SEP-YXWZPGCWM5AYTRC5</code></li>
</ol>
<hr>
<p>查看第一条<code>KUBE-SEP-YZI6E5F46FBZHQJD</code>规则，最后会被转发到<code>172.29.16.3</code>的pod<code>80</code>端口上</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112231436062.png" srcset="/img/loading.gif" lazyload alt="image-20211223143614670"></p>
<p>查看这三条规则，iptables 将访问 Service 的流量转发到后端 Pod，而且使用类似轮询的负载均衡策略</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112231437094.png" srcset="/img/loading.gif" lazyload alt="image-20211223143717405"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/k8s/">k8s</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/01/19/Docker/">
                        <span class="hidden-mobile">Docker</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
