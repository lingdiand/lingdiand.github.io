

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  
  <title>Redis - 点了个点点</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/rainbow.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.9","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":9},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>点</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Redis">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-05-17 21:19" pubdate>
        May 17, 2022 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      78
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Redis</h1>
            
            <div class="markdown-body">
              <h1 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h1><h2 id="默认安装"><a href="#默认安装" class="headerlink" title="默认安装"></a>默认安装</h2><p>以Ubuntu为例</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">apt-get install redis-server<br></code></pre></div></td></tr></table></figure>

<p>这种方式会把Redis安装到<code>/usr/bin/</code>下，但安装的版本可能不是最新的</p>
<h2 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h2><p>使用apt安装的话，卸载很简单：</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">apt-get purge --auto-remove redis-server<br></code></pre></div></td></tr></table></figure>

<h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><p>需要确保已经安装了gcc和tcl</p>
<p>官网下载安装包，放到linux某个目录(这里放到/data目录下)</p>
<p>执行以下命令</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">解压</span><br>tar zxf redis-stable.tar.gz<br><span class="hljs-meta">#</span><span class="bash">进入目录</span><br>cd redis-stable/<br><span class="hljs-meta">#</span><span class="bash">编译</span><br>make -j4<br><span class="hljs-meta">#</span><span class="bash">安装</span><br>make install<br></code></pre></div></td></tr></table></figure>

<p>这样，Redis就安装在了<code>/usr/local/bin/</code>下，但是redis的配置文件还在安装包的目录下(/data/redis-stable/redis.conf)</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">将其拷贝至/etc/redis/下</span><br>mkdir -p /etc/redis/<br>cp redis.conf /etc/redis/<br></code></pre></div></td></tr></table></figure>

<h2 id="卸载-1"><a href="#卸载-1" class="headerlink" title="卸载"></a>卸载</h2><ol>
<li><p>停止redis服务</p>
</li>
<li><p>删除/usr/local/bin下的redis文件</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">rm -rf /usr/local/bin/redis*<br></code></pre></div></td></tr></table></figure></li>
<li><p>删除配置文件<code>/etc/redis/redis.conf</code></p>
</li>
<li><p>还可进一步删除源码包</p>
</li>
</ol>
<hr>
<h2 id="服务端运行"><a href="#服务端运行" class="headerlink" title="服务端运行"></a>服务端运行</h2><p>Redis运行需要配置文件，而配置文件在<code>/etc/redis/</code>下</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">启动redis服务端</span><br>redis-server /etc/redis/redis.conf<br></code></pre></div></td></tr></table></figure>

<p>Redis默认是非daemeon的，可以将配置文件中修改为<code>daemonize yes</code></p>
<h2 id="客户端运行"><a href="#客户端运行" class="headerlink" title="客户端运行"></a>客户端运行</h2><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">redis-cli<br></code></pre></div></td></tr></table></figure>

<h1 id="二、相关知识介绍"><a href="#二、相关知识介绍" class="headerlink" title="二、相关知识介绍"></a>二、相关知识介绍</h1><p>redis默认有16（0~15）个数据库，默认使用0号库<br>通过命令<code>select n</code>来切换数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">dbsize 		#查看当前数据库的key的数量<br>flushdb 	#清空当前库<br>flushall 	#清空所有库<br></code></pre></div></td></tr></table></figure>

<p>redis是单线程+多路IO复用技术</p>
<h1 id="三、常用数据类型"><a href="#三、常用数据类型" class="headerlink" title="三、常用数据类型"></a>三、常用数据类型</h1><p><strong>Redis键操作</strong></p>
<p> redis是key:value数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">keys *		#查看当前库所有key<br>exists key	#判断某个key是否存在<br>type key	#查看key的类型<br>del key		#删除key<br>expire key 10 #给指定的key设置过期时间，单位秒<br>ttl key		  #查看还有多少秒过期，-1永不过期，-2已过期<br></code></pre></div></td></tr></table></figure>

<h2 id="String"><a href="#String" class="headerlink" title="String"></a>String</h2><blockquote>
<p> 一个key对应一个value</p>
<p>String类型并不表示只能存字符串，比如存储数组[1,2,3]，在String中会转换为”[1,2,3]”；也可存整型类型。value最大为512M</p>
</blockquote>
<ol>
<li>set <key><value>    设置key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; set k1 123456<br>OK<br></code></pre></div></td></tr></table></figure>

<ol start="2">
<li>get <key>    查看</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; get k1<br>&quot;123456&quot;<br></code></pre></div></td></tr></table></figure>

<ol start="3">
<li>append <key><value>    将给定的值追加到原值的末尾</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; append k1 000<br>(integer) 9<br>127.0.0.1:6379&gt; get k1<br>&quot;123456000&quot;<br></code></pre></div></td></tr></table></figure>

<ol start="4">
<li>strlen <key>    获得长度</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; strlen k1<br>(integer) 9<br></code></pre></div></td></tr></table></figure>

<ol start="5">
<li>setnx <key><value>    只有当key不存在时，设置key的值</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">k1存在，返回0失败</span><br>127.0.0.1:6379&gt;  setnx k1 22<br>(integer) 0<br><span class="hljs-meta">#</span><span class="bash">k2不存在，设置成功</span><br>127.0.0.1:6379&gt;  setnx k2 22<br>(integer) 1<br></code></pre></div></td></tr></table></figure>

<ol start="6">
<li>incr <key>    将key中存储的数字+1，只能对数字值进行操作；如果为空（key不存在），新增值为1</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt;  incr k1<br>(integer) 123456001<br></code></pre></div></td></tr></table></figure>

<ol start="7">
<li><p>decr <key>    将key中存储的数字-1</p>
</li>
<li><p>incrby/decrby <key><step>    自定义设置key存储的数字增加/减少多少</p>
</li>
</ol>
<ol start="9">
<li><p>mset <key1><value1>…<keyn><valuen>    同时设置一个或多个key-value</p>
</li>
<li><p>mget <key1>…<keyn>    同时获得一个或多个value</p>
</li>
<li><p>msetnx <key1><value1>…<keyn><valuen>    同时设置一个或多个key-value（需所有key都不存在）</p>
</li>
<li><p>getrange <key>&lt;起始位置&gt;&lt;结束位置&gt;    获得值的范围</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt;  set name lingdiand<br>OK<br>127.0.0.1:6379&gt; GETRANGE name 0 1<br>&quot;li&quot;<br></code></pre></div></td></tr></table></figure>

<ol start="13">
<li>setrange <key>&lt;起始位置&gt;<value>    用value覆盖key所存储的字符串值，从&lt;起始位置&gt;开始</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; SETRANGE name 4 555<br>(integer) 9<br>127.0.0.1:6379&gt; get name<br>&quot;ling555nd&quot;<br></code></pre></div></td></tr></table></figure>

<ol start="14">
<li><p>setex <key>&lt;过期时间&gt;<value>    设置键值的同时设置过期时间，单位秒</p>
</li>
<li><p>getset <key><value>    设置新值的同时设置旧值</p>
</li>
</ol>
<hr>
<p><strong>数据结构</strong></p>
<p>String的<strong>value</strong>数据结构为简单动态字符串（SDS），类似于java的ArrayList，采用预分配冗余空间的方式来减少内存的频繁分配</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112192036701.png" srcset="/img/loading.gif" lazyload alt="image-20211219203612155"></p>
<p>capacity为分配的空间，但是可使用的空间为len（即会预留一部分空的空间）</p>
<p>当实际存储的字符串超过len时：</p>
<ul>
<li>当存储的字符串长度小于1M时，扩容加倍现有的空间</li>
<li>如果超过1M，扩容时只会多扩1M的空间（因为每次都是加倍现有空间的只会越来越大。假如字符串长度为2M，存储为3M。当字符串长度为3M时，存储为4M而不是6M，节省空间）</li>
</ul>
<h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><p> 队列    一个key对应多个value</p>
<p>它的底层其实是个双向链表，所以对两端的操作性能很强，对中间节点的操作性能会较差</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112192101901.png" srcset="/img/loading.gif" lazyload alt="image-20211219210108097"></p>
<p>lpush / rpush &lt;key&gt;&lt;value1&gt;…&lt;valuen&gt;    从左边 / 右边插入一个或多个值</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; lpush k1 aa bb cc dd<br>(integer) 4<br><span class="hljs-meta">#</span><span class="bash">lpush是左侧添加，第一次aa，第二次bb aa，第三次cc bb aa....</span><br>127.0.0.1:6379&gt; lrange k1 0 -1<br>1) &quot;dd&quot;<br>2) &quot;cc&quot; <br>3) &quot;bb&quot;<br>4) &quot;aa&quot;<br></code></pre></div></td></tr></table></figure>

<ol>
<li><p>lpop / rpop    &lt;key&gt;    从左边 / 右边取出一个值（值在键在，值光键亡）</p>
</li>
<li><p>rpoplpush &lt;key1&gt;&lt;key2&gt;    从key1右边取出一个值，添加到key2的左边 </p>
</li>
<li><p>lrange &lt;key&gt;&lt;start&gt;&lt;end&gt;    按照索引下标获得元素（从左到右）0 -1 表所有</p>
</li>
<li><p>lindex&lt;key&gt;&lt;index&gt;    根据索引下标获得元素（从左到右）</p>
</li>
<li><p>llen&lt;key&gt;    获得列表的长度</p>
</li>
<li><p>linsert <key> before/after <value><newValue>    在value前/后插入新值        （根据值）</p>
</li>
<li><p>lrem <key><n><value>    从左边开始删除n个value（从左到右）</p>
</li>
<li><p>lset <key><index><value>    将列表key下标为index的值替换为value        （根据下标）</p>
</li>
</ol>
<hr>
<p><strong>数据结构</strong></p>
<p>list的数据结构为快速链表quickList</p>
<p>在列表元素较少时会采用一块连续的内存存储，所有元素紧挨在一起存储，这个结构是ziplist（类似于数组）</p>
<p>当列表元素较多时会改为quicklist（链表），一个quicklist由多个ziplist组成</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202112202204064.png" srcset="/img/loading.gif" lazyload alt="image-20211220220445575"></p>
<p>Redis将链表和ziplist结合起来组成了quicklist，即将多个ziplist使用双向指针串起来，这样既满足了快速的插入删除性能，又不会出现太大的空间冗余</p>
<h2 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h2><p>Set和list类似，不同点在于set不允许重复值，是无序的。 如果需要存储列表数据，并不希望出现重复数据，可使用Set，例：关注人<br>Set的底层是一个value为null的哈希表，对于添加、删除、查找的复杂度都是O(1)</p>
<ol>
<li><p>sadd &lt;key&gt;&lt;value1&gt;&lt;value2&gt;….. 将一个或多个元素添加到key中，相同元素将被忽略。</p>
</li>
<li><p>smembers &lt;key&gt;    查看该集合中所有值。</p>
</li>
<li><p>sismember &lt;key&gt;&lt;value&gt; 判断key中是否存在value，有1，没有0。</p>
</li>
<li><p>scard &lt;key&gt; 返回该集合中的元素个数。</p>
</li>
<li><p>srem &lt;key&gt;&lt;value&gt;&lt;value2&gt;….    删除该集合中的某个元素。</p>
</li>
<li><p>spop &lt;key&gt;  随机<strong>取出</strong>该集合中一个值。</p>
</li>
<li><p>srandmember &lt;key&gt;&lt;n&gt; 随机<strong>查看</strong>该集合中n个值。</p>
</li>
<li><p>smove &lt;key1&gt;&lt;key2&gt;&lt;value&gt;    将key1中value移动到key2中。</p>
</li>
<li><p>sinter &lt;key1&gt;&lt;key2&gt;    输出两个集合的交集元素</p>
</li>
<li><p>sunion &lt;key1&gt;&lt;key2&gt;    输出两个集合的并集元素</p>
</li>
<li><p>sdiff &lt;key1&gt;&lt;key2&gt;    输出两个集合中的差集元素(不存在于key2中的key1元素)</p>
</li>
</ol>
<hr>
<p><strong>数据结构</strong></p>
<p>Set的数据结构是dict字典，字典是采用哈希表进行实现的。这就说明了为什么Set的元素不会重复，加入Set时会根据元素的值计算出元素的下标，相同的元素那么下标也会相同</p>
<h2 id="Zset"><a href="#Zset" class="headerlink" title="Zset"></a>Zset</h2><p>Zset与set类似，都是没有重复元素的，不同在于Zset每个元素都关联了一个评分(score)，score被用来按照从低到高排序每个元素，因为元素是有序的，所以也可根据score或次序(position)获取一个范围内容的元素</p>
<ol>
<li>zadd &lt;key&gt;&lt;score1&gt;&lt;value1&gt;&lt;score2&gt;&lt;value2&gt;    将一个或多个元素及其score添加到key中</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; zadd top 1 java 2 c++ 100 php 5 mysql<br></code></pre></div></td></tr></table></figure>

<ol start="2">
<li>zrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;[withscores]    按照索引下标输出元素。0 -1 表所有,withscores可以带上score一起返回</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; zrange top 0 -1 withscores<br></code></pre></div></td></tr></table></figure>

<ol start="3">
<li><p>zrangebyscore &lt;key&gt; &lt;min&gt; &lt;max&gt; [withscores]    返回某个score范围内容的值</p>
</li>
<li><p>zrevrangebyscore &lt;key&gt; &lt;max&gt; &lt;min&gt; [withscores] 同上，从大到小排序</p>
</li>
<li><p>zincrby &lt;key&gt;&lt;n&gt;&lt;value&gt;    为元素的score加上n</p>
</li>
<li><p>zrem &lt;key&gt;&lt;value&gt;    删除key中指定的value</p>
</li>
<li><p>zcount &lt;key&gt;&lt;min&gt;&lt;max&gt;    统计该区间的元素个数</p>
</li>
<li><p>zrank &lt;key&gt;&lt;value&gt;    返回该value在集合中的排名，从0开始</p>
</li>
</ol>
<hr>
<p><strong>数据结构</strong></p>
<p>Zset的数据结构很特别，一方面它等价于Java的Map&lt;String,Double&gt;，String是value，Double是score，可以给每个value赋值一个权重score，另一方面它又类似于TreeSet，value根据权重score进行排序。</p>
<p>Zset底层使用了两个数据结构</p>
<ol>
<li><p>hash，hash的作用在于关联value和score</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202204221751543.png" srcset="/img/loading.gif" lazyload alt="image-20220422175117494"></p>
</li>
<li><p>跳跃表，目的在于给value排序，根据score的范围获取元素列表</p>
<p>跳跃表(skipList)是一种可以替代平衡树的数据结构，跳跃表让已排序的数据分布在多层次的链表结构中，默认是将 Key 值升序排列的，以 0-1 的随机值决定一个数据是否能够攀升到高层次的链表中。它通过容许一定的数据冗余，达到 “以空间换时间” 的目的。</p>
<p>一个跳跃表有若干层链表组成；</p>
<p>最底层包含所有数据；</p>
<p>如果一个元素出现在第 i 层，那么比 i 小的层都包含该元素；</p>
<p>第 i 层的元素通过一个指针指向下一层拥有相同值的元素；</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202204221804151.png" srcset="/img/loading.gif" lazyload alt="image-20220422180420166"></p>
<p>例：要查找51，首先在最高层查找：1比51小，指针右移，21比51小，指针右移，为null，第二层找完了也没有，指针左移，下移到下一层下一个节点，41比51小，指针右移，61比51大，指针左移，下移到下一层下一个节点找到51</p>
</li>
</ol>
<h2 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h2><p>hash是一个键值对集合，类似于Java中的Map&lt;String,Object&gt;，其中String为键(field)，Object为value。<br>例：用户id为key，value为用户对象数据(name、age、sex)。hash适合存储对象</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202204221029812.png" srcset="/img/loading.gif" lazyload alt="image-20220422102933473"></p>
<p>这样通过key（用户的ID）+field（属性标签）可操作对应的属性数据</p>
<ol>
<li>hset &lt;key&gt;&lt;field&gt;&lt;value&gt;    给key中的field赋值value</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell"><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">6379</span>&gt; hset user:<span class="hljs-number">1001</span> id <span class="hljs-number">1001</span> <br></code></pre></div></td></tr></table></figure>

<ol start="2">
<li>hget &lt;key&gt;&lt;field&gt;    从key中取出field的值</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell"><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">6379</span>&gt; hget user:<span class="hljs-number">1001</span> id<br><span class="hljs-string">&quot;1001&quot;</span><br></code></pre></div></td></tr></table></figure>

<ol start="3">
<li><p>hmset &lt;key&gt;&lt;field1&gt;&lt;value1&gt;&lt;field2&gt;&lt;value2&gt;…    批量设置hash值</p>
</li>
<li><p>hexists &lt;key&gt;&lt;field&gt;    判断是否存在field</p>
</li>
<li><p>hkeys &lt;key&gt;    查看key中所有field</p>
</li>
<li><p>hvals &lt;key&gt;    查看key中所有value</p>
</li>
<li><p>hincrby &lt;key&gt;&lt;field&gt;&lt;n&gt;    为key中field的值加上n</p>
</li>
<li><p>hsetnx &lt;key&gt;&lt;field&gt;&lt;value&gt;    当field不存在时，将field的值设为value</p>
</li>
</ol>
<hr>
<p><strong>数据结构</strong></p>
<p>hash的数据结构为ziplist和hashtable。当field-value长度较短、个数较少时，使用ziplist，否则使用hashtable</p>
<h1 id="四、配置文件"><a href="#四、配置文件" class="headerlink" title="四、配置文件"></a>四、配置文件</h1><p>启动redis时需要配置文件redis.conf</p>
<h2 id="Units单位"><a href="#Units单位" class="headerlink" title="Units单位"></a>Units单位</h2><p>配置大小单位，只支持bytes，不支持bit，大小写不敏感</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202204231405848.png" srcset="/img/loading.gif" lazyload alt="image-20220423140508697"></p>
<h2 id="include"><a href="#include" class="headerlink" title="include"></a>include</h2><p>当前文件也可包含其他配置文件</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202204231406518.png" srcset="/img/loading.gif" lazyload alt="image-20220423140611472"></p>
<h2 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h2><p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202204231407622.png" srcset="/img/loading.gif" lazyload alt="image-20220423140728527"></p>
<p><strong>bind</strong></p>
<p>默认bind=127.0.0.1，表示访问redis只能通过127.0.0.1访问，即本地访问</p>
<p><strong>protected-mode</strong></p>
<p>保护模式，默认yes打开，不运行远程访问。如需要远程访问，将bind注释掉，protected-mode改为no</p>
<p><strong>port</strong></p>
<p>端口</p>
<p><strong>tcp-backlog</strong></p>
<p>设置tcp的backlog，backlog是一个连接队列，backlog队列总和=未完成三次握手队列+已完成三次握手队列。</p>
<p>默认为511次，如需要高并发，需要一个高bakclog值来避免客户端连接慢的问题</p>
<p><strong>timeout</strong></p>
<p>超时时间（秒），默认0（永不超时）</p>
<p>连接redis后多少秒后没操作会断开连接</p>
<p><strong>tcp-keepalive</strong></p>
<p>检查心跳时间，默认300秒。即每隔300秒redis服务端向客户端发送一次请求，检查客户端是否还活着。</p>
<h2 id="GENERAL通用"><a href="#GENERAL通用" class="headerlink" title="GENERAL通用"></a>GENERAL通用</h2><p><strong>daemonize</strong></p>
<p>Redis默认不是以守护进程的方式运行，可以通过该配置项修改，使用yes启用守护进程</p>
<p><strong>pidfile</strong></p>
<p>存放pid文件的位置，每个实例都会产生一个不同的pid文件</p>
<p>当Redis以守护进程方式运行时，Redis默认会把pid写入/var/run/redis.pid文件，可以通过pidfile指定</p>
<p><strong>loglevel</strong></p>
<p>日志级别</p>
<p><strong>logfile</strong></p>
<p>日志文件输出路径，默认为空</p>
<p><strong>databases</strong></p>
<p>数据库</p>
<h2 id="SECURITY安全"><a href="#SECURITY安全" class="headerlink" title="SECURITY安全"></a>SECURITY安全</h2><p><strong>密码</strong></p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202204231428639.png" srcset="/img/loading.gif" lazyload alt="image-20220423142831659"></p>
<p>默认是没有密码，将其注释取消掉</p>
<p>也可以在命令种临时设置密码（重启后，密码就还原了）</p>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202204231437282.png" srcset="/img/loading.gif" lazyload alt="image-20220423143740906"></p>
<h2 id="LIMITS限制"><a href="#LIMITS限制" class="headerlink" title="LIMITS限制"></a>LIMITS限制</h2><p><strong>maxclients</strong></p>
<p>最多可以同时与多少个客户端连接，默认1000</p>
<p><strong>maxmemory</strong></p>
<p>最大内存</p>
<h1 id="五、发布订阅"><a href="#五、发布订阅" class="headerlink" title="五、发布订阅"></a>五、发布订阅</h1><h2 id="什么是发布订阅"><a href="#什么是发布订阅" class="headerlink" title="什么是发布订阅"></a>什么是发布订阅</h2><p>发布订阅(pub/sub)是一种消息通信模式：发送者(pub)发送消息，订阅者(sub)接受消息。</p>
<ol>
<li>redis客户端可以订阅任意数量的频道</li>
</ol>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202204231610433.png" srcset="/img/loading.gif" lazyload alt="image-20220423161020465"></p>
<ol start="2">
<li>当这个频道发布消息后，消息就会发送给订阅的客户端</li>
</ol>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202204231628591.png" srcset="/img/loading.gif" lazyload alt="image-20220423162828549"></p>
<h2 id="发布订阅实现"><a href="#发布订阅实现" class="headerlink" title="发布订阅实现"></a>发布订阅实现</h2><ol>
<li>打开一个客户端订阅channel1</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; SUBSCRIBE channel1<br>Reading messages... (press Ctrl-C to quit)<br>1) &quot;subscribe&quot;<br>2) &quot;channel1&quot;<br>3) (integer) 1<br></code></pre></div></td></tr></table></figure>

<ol start="2">
<li>打开另一个客户端，通过channel1发布消息hello</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; PUBLISH channel1 hello<br>(integer) 1 <br></code></pre></div></td></tr></table></figure>

<p>​    返回的1为订阅者数量</p>
<ol start="3">
<li>打开第一个客户端可以看到发送的消息</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">1) &quot;message&quot;<br>2) &quot;channel1&quot;<br>3) &quot;hello&quot;<br></code></pre></div></td></tr></table></figure>

<h1 id="六、新数据类型"><a href="#六、新数据类型" class="headerlink" title="六、新数据类型"></a>六、新数据类型</h1><p>redis在新版本中出现了几个新的类型</p>
<h2 id="Bitmaps"><a href="#Bitmaps" class="headerlink" title="Bitmaps"></a>Bitmaps</h2><blockquote>
<p>进行位操作</p>
</blockquote>
<p>现代计算机采用二进制（位），1个字节=8位。</p>
<p>“abc”由3个字节组成，在计算机存储时采用二进制位表示，abc的ASCII码为97、98、99，二进制位是01100001、01100010、01100011</p>
<p>所以通过操作位能够有效提高使用效率，相当于跳过了字节转换为位，直接操作计算机最底层存储数据。</p>
<ol>
<li>Bitmaps本身不是一种数据结构，实际上它是字符串（key-value），但它可以对字符串进行位操作。</li>
<li>Bitmaps单独提供了一套命令，所以命令不同与其他数据类型。可以把Bitmaps当成一个以位为单位的数组，只能存储0和1，下标在Bitmaps叫做偏移量。</li>
</ol>
<p><img src="https://gitee.com/lingdiand/image-repo/raw/master/202204231644441.png" srcset="/img/loading.gif" lazyload alt="image-20220423164443286"></p>
<hr>
<p><strong>命令</strong></p>
<ol>
<li><p>setbit &lt;key&gt;&lt;offset&gt;&lt;value&gt;    设置Bitmaps中某个偏移量的值(0或1)</p>
<p>例：每个用户是否访问过网站存放在Bitmaps中，访问过记做1，没访问过记做0，偏移量作为用户id。</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; setbit users:20220423 1 1<br></code></pre></div></td></tr></table></figure></li>
<li><p>getbit &lt;key&gt;&lt;offset&gt;  获取某个偏移量的值。因为5不存在，返回也是0</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; getbit users:20220423 1<br>(integer) 1<br>127.0.0.1:6379&gt; getbit users:20220423 5<br>(integer) 0<br></code></pre></div></td></tr></table></figure></li>
<li><p>bitcount &lt;key&gt;[start end]  统计字符串从start到end范围内比特值为1的数量。start、end可使用负值，-1最后一位，-2倒数第二位</p>
</li>
<li><p>bittop and/or/not/xor &lt;destkey&gt; [key…]  求多个Bitmaps的and(交集)、or(并集)、not(非)、xor(异或)，将结果存在destkey中</p>
</li>
</ol>
<h2 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h2><p>HyperLogLog用来做基数统计（求集合中不重复元素个数）的算法，优点在于速度快、运行效率高，计算基数所需的空间总是固定的</p>
<p>需要注意的是HyperLogLog只是用来计算基数，不能存储 </p>
<p><strong>什么是基数</strong></p>
<p>数据集{1,3,5,7,5,7,8}，基数集为{1,3,5,7,8}，基数就是5（有5个不重复元素）</p>
<hr>
<p><strong>命令</strong></p>
<ol>
<li><p>pfadd <key><element>[element…]    添加元素到HyperLogLog中</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; pfadd h1 redis<br>(integer) 1<br></code></pre></div></td></tr></table></figure></li>
<li><p>pfcount <key>[key….]    计算key的近似基数</p>
</li>
<li><p>pfmerge <destkey><sourcekey>[sourcekey…] 将一个或多个sourcekey存在destkey中，比如每月活跃用户可以用每天的活跃用户合并可得</p>
</li>
</ol>
<h2 id="Geospatial"><a href="#Geospatial" class="headerlink" title="Geospatial"></a>Geospatial</h2><p>GEO：Geographic，地理信息的缩写。</p>
<p>该类型是元素的二维坐标，redis基于该类型，提供了经纬度设置、查询等</p>
<hr>
<p><strong>命令</strong></p>
<ol>
<li><p>geoadd &lt;key&gt;&lt;longitude&gt;&lt;latitude&gt;&lt;member&gt;    添加地理位置(经度，纬度，名称)</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; geoadd china:city 121.47 31.23 shanghai<br>(integer) 1<br></code></pre></div></td></tr></table></figure></li>
<li><p>geopos <key><member>[member…]    获得指定地区的坐标值</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">127.0.0.1:6379&gt; geopos china:city shanghai<br>1) 1) &quot;121.47000163793563843&quot;<br>   2) &quot;31.22999903975783553&quot;<br></code></pre></div></td></tr></table></figure></li>
<li><p>geodist <key><member1><member2> [m|km]获得两个地区位置之间的直线距离</p>
</li>
<li><p>georadius <key> &lt;longitude&gt;&lt;latitude&gt; <radius> m|km   以给定的经纬度为中心，找出某一半径内的元素</p>
</li>
</ol>
<h1 id="七、Jedis"><a href="#七、Jedis" class="headerlink" title="七、Jedis"></a>七、Jedis</h1><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<figure class="highlight arduino"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">String</span> ...arg)</span></span>&#123;<br>    <span class="hljs-comment">//创建客户端</span><br>    Jedis jedis=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Jedis</span>(<span class="hljs-string">&quot;121.196.221.116&quot;</span>,<span class="hljs-number">6379</span>);<br>    <span class="hljs-comment">//测试</span><br>    <span class="hljs-keyword">String</span> test=jedis.<span class="hljs-built_in">ping</span>();<br>    System.out.<span class="hljs-built_in">println</span>(test);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>注：远程访问需要将配置文件中bind注释掉，protected-mode改为no</p>
<h1 id="八、事务操作"><a href="#八、事务操作" class="headerlink" title="八、事务操作"></a>八、事务操作</h1><p>redis事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序执行。事务在执行过程中，不会被其他客户端发送来的命令请求所打断</p>
<blockquote>
<p>redis事务的主要作用就是串联多个命令防止别的命令插队</p>
</blockquote>
<h2 id="Multi、Exec、discard"><a href="#Multi、Exec、discard" class="headerlink" title="Multi、Exec、discard"></a>Multi、Exec、discard</h2><p>首先输入<code>multi</code>，之后输入的命令将会依次进入命令队列中等待，输入<code>exec</code>后，redis会将命令队列中的命令依次执行</p>
<p> 在输入命令的过程中假如输错了、少输了，可以使用<code>discard</code>放弃输入阶段</p>
<p><img src="images/image-20220526173936339.png" srcset="/img/loading.gif" lazyload alt="image-20220526173936339"></p>
<ol>
<li>命令队列中某个命令出现错误（明显的编译错误），则所有命令都会取消</li>
<li>执行阶段某个命令出现错误（运行时错误），则只有错误命令不执行</li>
</ol>
<h2 id="事务冲突"><a href="#事务冲突" class="headerlink" title="事务冲突"></a>事务冲突</h2><p>例：同一个银行卡，有很多人去消费，如何解决数据冲突问题</p>
<p>通过上锁的机制解决</p>
<h3 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h3><p><strong>每次操作前将数据上锁</strong></p>
<p>每次操作数据时都认为别人会修改，所以就提前上锁。传统的关系型数据库里面就用了悲观锁机制，比如行锁、表锁、读锁、写锁，每次操作前上锁</p>
<h3 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h3><p> 每次操作数据时都认为别人不会修改，所以不会上锁，而是在更新时判断一下别人有没有更新这个数据，可以使用版本号等机制。乐观锁用于多读的应用类型，可以提高吞吐量，Redis就是采用这个check-and-set机制实现事务的、还有抢票</p>
<p>例：10000元，版本号1.0，A操作后变成了2000元，版本号1.1；B操作时检查判断版本号等不等于1.1，不等的话重新更新数据</p>
<h3 id="WATCH"><a href="#WATCH" class="headerlink" title="WATCH"></a>WATCH</h3><p>在执行<code>multi</code>之前，先执行watch key1 [key2]可以监视一个或多个key，如果在事务执行之前这些key被其他命令所改动，那么事务将被打断  </p>
<h3 id="UNWATCH"><a href="#UNWATCH" class="headerlink" title="UNWATCH"></a>UNWATCH</h3><p>取消<code>watch</code>命令对所有key的监视</p>
<h2 id="事务三特性"><a href="#事务三特性" class="headerlink" title="事务三特性"></a>事务三特性</h2><ol>
<li><p>单独的隔离操作</p>
<p>事务中所有命令都会序列化、顺序执行。事务在执行的过程中，不会被其他客户端发送的命令所打断</p>
</li>
<li><p>没有隔离级别的概念</p>
<p>队列中的命令没有提前之前都不会实际执行</p>
</li>
<li><p>不保证原子性</p>
<p>事务中如果有一条命令执行失败，其后命令任然执行，没有回滚</p>
</li>
</ol>
<h1 id="持久化之RDB"><a href="#持久化之RDB" class="headerlink" title="持久化之RDB"></a>持久化之RDB</h1><p>redis的数据都在内存中，但也可以在硬盘中，将内存中的数据写入硬盘中的过程就是持久化</p>
<h2 id="RDB介绍"><a href="#RDB介绍" class="headerlink" title="RDB介绍"></a>RDB介绍</h2><p>RDB(Redis DataBase)指的是在指定的<strong>时间间隔</strong>内将内存中的数据集<strong>快照</strong>写入磁盘。恢复是将快照文件直接读到内存里。<strong>RDB默认开启</strong></p>
<h2 id="备份是如何执行的"><a href="#备份是如何执行的" class="headerlink" title="备份是如何执行的"></a>备份是如何执行的</h2><p>redis持久化后生成的快照文件为<code>dump.rdb</code>，在备份的过程中并不是直接覆盖原文件</p>
<p>redis会单独创建(fork)一个子进程进行持久化，先将数据写入到一个<strong>临时文件</strong>中，等到持久化结束了，用这个<strong>临时文件替换上次持久化好的文件</strong>。在整个过程中，主进程不进行任何IO操作，这就确保了极高的性能，如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB比AOF更高效，RDB的缺点是最后一次持久化的数据可能会丢失</p>
<p><img src="images/image-20220530102155328.png" srcset="/img/loading.gif" lazyload alt="image-20220530102155328"></p>
<h2 id="Fork命令"><a href="#Fork命令" class="headerlink" title="Fork命令"></a>Fork命令</h2><p>fork的作用是复制一个与当前进一样的进程，包括数据（变量、环境变量、程序计数器等），并作为原进程的子进程</p>
<p>在Linux程序中，fork()会产生一个和父进程完全相同的子进程，但子进程在此后会用exec系统调用，出于效率考虑，linux引入了“写时复制技术”</p>
<p>父子进程共用一段物理内存，只有当进程空间内各段数据要改变时，会将父进程内容复制一份给子进程</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>在redis.conf配置文件中，备份文件默认为dump.rdb</p>
<p><code>save 秒 key</code>：指定持久化操作（多少秒内有几个key改变了）的触发操作（save只管保存，会阻塞，不建议设置）</p>
<p><code>bgsave</code>：redis会在后台异步进行快照操作，快照同时还可以响应客户端请求，还可以使用lastsave命令获取最后一次成功执行快照的时间</p>
<p><code>stop-writes-on-bgsave-error yes</code>：当redis无法写入磁盘，就会关掉redis的写操作</p>
<p><code>rdbcompression yes</code>：持久化的文件是否进行压缩，压缩使用LZF算法</p>
<p><code>rdbchecksum yes</code>：存储快照后，使用CRC64算法进行数据校验</p>
<p><code>dbfilename dump.rdb</code>：备份文件名称</p>
<p><code>dir ./</code>：备份文件目录</p>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><p><strong>优点</strong></p>
<ol>
<li>适合大规模的数据恢复</li>
<li>适合对数据完整性和一致性要求不高</li>
<li>节省磁盘空间</li>
<li>恢复速度块</li>
</ol>
<p><strong>缺点</strong></p>
<ol>
<li>fork时，内存数据被克隆了一份，大致2倍的膨胀性</li>
<li>虽然redis在fork时使用了写时拷贝技术，但数据庞大时还是比较消耗性能</li>
<li>在备份周期每个一段时间做一次备份，如果redis意外挂掉，就会丢失最后一次快照后的所有修改</li>
</ol>
<h1 id="持久化之AOF"><a href="#持久化之AOF" class="headerlink" title="持久化之AOF"></a>持久化之AOF</h1><h2 id="AOF介绍"><a href="#AOF介绍" class="headerlink" title="AOF介绍"></a>AOF介绍</h2><p>AOF(Append Only File)以日志的形式记录每个写操作，将redis执行过的所有写指令记录下来(读操作不记录)，只需追加文件不可以改写文件。redis在启动之初会读取该文件重新构建数据，即redis会调用日志文件的命令从前到后执行一次以完成数据的恢复工作</p>
<p>AOF默认不开启，可以在redis.conf配置，<code>appendonly no</code>改为<code>yes</code>开启，默认存储文件名为<code>appendonly.aof</code></p>
<p>如果RDB和AOF同时开启，系统默认取AOF</p>
<h2 id="AOF持久化流程"><a href="#AOF持久化流程" class="headerlink" title="AOF持久化流程"></a>AOF持久化流程</h2><ol>
<li>客户端的请求写命令被append追加到AOF缓冲区中</li>
<li>AOF缓冲区根据配置文件策略(always、everysec、no)将操作同步到磁盘的AOF文件中</li>
<li>AOF文件大小超过重写策略或手动重写时，会对AOF文件rewrite重写，压缩文件容量大小</li>
</ol>
<h2 id="AOF启动-修复-恢复"><a href="#AOF启动-修复-恢复" class="headerlink" title="AOF启动/修复/恢复"></a>AOF启动/修复/恢复</h2><p>AOF的机制与RDB不同，但备份和恢复的操作与RDB一样，都是拷贝备份文件，需要恢复时再拷贝至redis工作目录下，启动系统即加载</p>
<p>正常恢复：</p>
<ul>
<li>开启AOF：修改<code>appendonly no</code>为<code>yes</code></li>
<li>将aof文件放在对应目录下(查看目录：config get dir)</li>
<li>重启redis，会自动加载aof文件的数据</li>
</ul>
<p>异常恢复：</p>
<ul>
<li>开启AOF：修改<code>appendonly no</code>为<code>yes</code></li>
<li>如遇到AOF文件损坏，通过<code>/usr/local/bin/redis-check-aof --fix appendonly.aof</code>进行恢复</li>
<li>将修复后的aof文件放在对应目录下(查看目录：config get dir)</li>
<li>重启redis，会自动加载aof文件的数据</li>
</ul>
<h2 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h2><p><strong>AOF同步频率设置</strong></p>
<p><code>appendfsync always</code>：始终同步。每次写操作立刻记入日志，性能较差但数据完整性好</p>
<p><code>appendfsync everysec</code>：每秒同步。每秒计入日志一次</p>
<p><code>appendfsync no</code>：redis不主动进行同步，将同步时机交给操作系统</p>
<h2 id="Rewrite压缩"><a href="#Rewrite压缩" class="headerlink" title="Rewrite压缩"></a>Rewrite压缩</h2><p>AOF采用文件追加方式，文件会越来越大，因此增加了重写机制，当AOF文件大小超过设定的阈值时，redis就会对AOF文件进行压缩，只保留可以恢复数据的最小指令集，可以使用命令<code>bgrewriteaof</code></p>
<p><strong>实现过程</strong>：AOF文件过大时，会fork出一条新进程将文件重写(也是先对临时文件重写再替换)，redis4.0之后的重写，是将RDB的快照，以二进制的形式附在新的AOF头部，作为已有的历史数据，替换掉原来的写操作。</p>
<p><strong>触发条件</strong>：redis会记录上次重写时AOF的大小，默认为当前AOF文件大小是上次重写后的一倍且大于64M时触发</p>
<p><code>auto-aof-rewrite-percentage</code>：设置重写的基准值，100指文件是原来文件的2倍时</p>
<p><code>auto-aof-rewrite-min-size</code>：设置重写的大小，最小文件为64MB，达到这个值开始重写</p>
<figure class="highlight arduino"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arduino"><span class="hljs-keyword">auto</span>-aof-rewrite-percentage <span class="hljs-number">100</span><br><span class="hljs-keyword">auto</span>-aof-rewrite-min-size <span class="hljs-number">64</span>mb<br></code></pre></div></td></tr></table></figure>

<p>系统载入时或上次重写完毕后，会记录此时AOF大小，记为base_size</p>
<p>当前大小&gt;=base_size+base_size*100%，且&gt;=64mb时重写</p>
<p><strong>重写过程</strong>：</p>
<ol>
<li><p>bgwriteaof触发重写，判断是否有bgsave、bgwriteaof在运行，有的话等待该命令结束再执行</p>
</li>
<li><p>主进程fork子进程执行重写操作，保证主进程不会阻塞</p>
</li>
<li><p>子进程遍历redis数据到临时文件中，同时客户端的写请求写入aof_buf缓冲区和aof_rewrite_buf重写缓冲区，以保证原AOF文件完整性和新AOF文件在生成期间的新的数据修改动作不会丢失</p>
</li>
<li><p>子进程写完新的AOF文件后，向主进程发信号，父进程更新统计信息。把aof_rewrite_buf中的数据写入新的AOF文件中</p>
</li>
<li><p>使用新的AOF文件覆盖旧的，完成重写</p>
</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Redis/">Redis</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/03/25/k8s/">
                        <span class="hidden-mobile">k8s</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
